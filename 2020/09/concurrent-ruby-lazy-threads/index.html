<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/styles.3881677f45ebbfb10fde.css" id="gatsby-global-css">/*! tailwindcss v2.2.7 | MIT License | https://tailwindcss.com
 */

/*! modern-normalize v1.1.0 | MIT License | https://github.com/sindresorhus/modern-normalize */html{-moz-tab-size:4;tab-size:4;line-height:1.15;-webkit-text-size-adjust:100%}body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif,Apple Color Emoji,Segoe UI Emoji}hr{height:0;color:inherit}abbr[title]{text-decoration:underline dotted}b,strong{font-weight:bolder}code,kbd,pre,samp{font-family:ui-monospace,SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}table{text-indent:0;border-color:inherit}button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0}button,select{text-transform:none}button{-webkit-appearance:button}legend{padding:0}progress{vertical-align:baseline}summary{display:list-item}blockquote,dd,dl,figure,h1,h2,h3,h4,h5,h6,hr,p,pre{margin:0}button{background-color:transparent;background-image:none}fieldset,ol,ul{margin:0;padding:0}ol,ul{list-style:none}html{font-family:ui-sans-serif,system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Arial,Noto Sans,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol,Noto Color Emoji;line-height:1.5}body{font-family:inherit;line-height:inherit}*,:after,:before{box-sizing:border-box;border:0 solid}hr{border-top-width:1px}img{border-style:solid}textarea{resize:vertical}input::placeholder,textarea::placeholder{opacity:1;color:#a1a1aa}button{cursor:pointer}table{border-collapse:collapse}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}button,input,optgroup,select,textarea{padding:0;line-height:inherit;color:inherit}code,kbd,pre,samp{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,Liberation Mono,Courier New,monospace}audio,canvas,embed,iframe,img,object,svg,video{display:block;vertical-align:middle}img,video{max-width:100%;height:auto}*,:after,:before{--tw-border-opacity:1;border-color:rgba(228,228,231,var(--tw-border-opacity))}.prose{color:#3f3f46;max-width:65ch}.prose a{color:#18181b;text-decoration:underline;font-weight:500}.prose a:hover{color:#c084fc}.prose strong{color:#18181b;font-weight:600}.prose ol>li{position:relative;padding-left:1.75em}.prose ol>li:before{content:counter(list-item,var(--list-counter-style,decimal)) ".";position:absolute;font-weight:400;color:#71717a;left:0}.prose ul>li{position:relative;padding-left:1.75em}.prose ul>li:before{content:"";position:absolute;background-color:#d4d4d8;border-radius:50%;width:.375em;height:.375em;top:.6875em;left:.25em}.prose hr{border-color:#e4e4e7;border-top-width:1px;margin-top:3em;margin-bottom:3em}.prose blockquote{font-weight:500;font-style:italic;color:#18181b;border-left-width:.25rem;border-left-color:#e4e4e7;quotes:"\201C""\201D""\2018""\2019";margin-top:1.6em;margin-bottom:1.6em;padding-left:1em}.prose blockquote p:first-of-type:before{content:open-quote}.prose blockquote p:last-of-type:after{content:close-quote}.prose h1{color:#18181b;font-weight:800;font-size:2.25em;margin-top:0;margin-bottom:.8888889em;line-height:1.1111111}.prose h2{color:#18181b;font-weight:700;font-size:1.5em;margin-top:2em;margin-bottom:1em;line-height:1.3333333}.prose h3{font-size:1.25em;margin-top:1.6em;margin-bottom:.6em;line-height:1.6}.prose h3,.prose h4{color:#18181b;font-weight:600}.prose h4{margin-top:1.5em;margin-bottom:.5em;line-height:1.5}.prose figure figcaption{color:#71717a;font-size:.875em;line-height:1.4285714;margin-top:.8571429em}.prose code{color:#18181b;font-weight:600;font-size:.875em}.prose code:after,.prose code:before{content:"`"}.prose a code{color:#18181b}.prose pre code{background-color:transparent;border-width:0;border-radius:0;padding:0;font-weight:400;color:inherit;font-size:inherit;font-family:inherit;line-height:inherit}.prose pre code:after,.prose pre code:before{content:none}.prose table{width:100%;table-layout:auto;text-align:left;margin-top:2em;margin-bottom:2em;font-size:.875em;line-height:1.7142857}.prose thead{color:#18181b;font-weight:600;border-bottom-width:1px;border-bottom-color:#d4d4d8}.prose thead th{vertical-align:bottom;padding-right:.5714286em;padding-bottom:.5714286em;padding-left:.5714286em}.prose tbody tr{border-bottom-width:1px;border-bottom-color:#e4e4e7}.prose tbody tr:last-child{border-bottom-width:0}.prose tbody td{vertical-align:top;padding:.5714286em}.prose{font-size:1rem;line-height:1.75}.prose p{margin-top:1.25em;margin-bottom:1.25em}.prose figure,.prose img,.prose video{margin-top:2em;margin-bottom:2em}.prose figure>*{margin-top:0;margin-bottom:0}.prose h2 code{font-size:.875em}.prose h3 code{font-size:.9em}.prose ol,.prose ul{margin-top:1.25em;margin-bottom:1.25em}.prose li{margin-top:.5em;margin-bottom:.5em}.prose>ul>li p{margin-top:.75em;margin-bottom:.75em}.prose>ul>li>:first-child{margin-top:1.25em}.prose>ul>li>:last-child{margin-bottom:1.25em}.prose>ol>li>:first-child{margin-top:1.25em}.prose>ol>li>:last-child{margin-bottom:1.25em}.prose ol ol,.prose ol ul,.prose ul ol,.prose ul ul{margin-top:.75em;margin-bottom:.75em}.prose h2+*,.prose h3+*,.prose h4+*,.prose hr+*{margin-top:0}.prose thead th:first-child{padding-left:0}.prose thead th:last-child{padding-right:0}.prose tbody td:first-child{padding-left:0}.prose tbody td:last-child{padding-right:0}.prose>:first-child{margin-top:0}.prose>:last-child{margin-bottom:0}.prose-sm{font-size:.875rem;line-height:1.7142857}.prose-sm p{margin-top:1.1428571em;margin-bottom:1.1428571em}.prose-sm blockquote{margin-top:1.3333333em;margin-bottom:1.3333333em;padding-left:1.1111111em}.prose-sm h1{font-size:2.1428571em;margin-top:0;margin-bottom:.8em;line-height:1.2}.prose-sm h2{font-size:1.4285714em;margin-top:1.6em;margin-bottom:.8em;line-height:1.4}.prose-sm h3{font-size:1.2857143em;margin-top:1.5555556em;margin-bottom:.4444444em;line-height:1.5555556}.prose-sm h4{margin-top:1.4285714em;margin-bottom:.5714286em;line-height:1.4285714}.prose-sm figure,.prose-sm img,.prose-sm video{margin-top:1.7142857em;margin-bottom:1.7142857em}.prose-sm figure>*{margin-top:0;margin-bottom:0}.prose-sm figure figcaption{font-size:.8571429em;line-height:1.3333333;margin-top:.6666667em}.prose-sm code{font-size:.8571429em}.prose-sm h2 code{font-size:.9em}.prose-sm h3 code{font-size:.8888889em}.prose-sm pre{font-size:.8571429em;line-height:1.6666667;margin-top:1.6666667em;margin-bottom:1.6666667em;border-radius:.25rem;padding:.6666667em 1em}.prose-sm ol,.prose-sm ul{margin-top:1.1428571em;margin-bottom:1.1428571em}.prose-sm li{margin-top:.2857143em;margin-bottom:.2857143em}.prose-sm ol>li{padding-left:1.5714286em}.prose-sm ol>li:before{left:0}.prose-sm ul>li{padding-left:1.5714286em}.prose-sm ul>li:before{height:.3571429em;width:.3571429em;top:.67857em;left:.2142857em}.prose-sm>ul>li p{margin-top:.5714286em;margin-bottom:.5714286em}.prose-sm>ul>li>:first-child{margin-top:1.1428571em}.prose-sm>ul>li>:last-child{margin-bottom:1.1428571em}.prose-sm>ol>li>:first-child{margin-top:1.1428571em}.prose-sm>ol>li>:last-child{margin-bottom:1.1428571em}.prose-sm ol ol,.prose-sm ol ul,.prose-sm ul ol,.prose-sm ul ul{margin-top:.5714286em;margin-bottom:.5714286em}.prose-sm hr{margin-top:2.8571429em;margin-bottom:2.8571429em}.prose-sm h2+*,.prose-sm h3+*,.prose-sm h4+*,.prose-sm hr+*{margin-top:0}.prose-sm table{font-size:.8571429em;line-height:1.5}.prose-sm thead th{padding-right:1em;padding-bottom:.6666667em;padding-left:1em}.prose-sm thead th:first-child{padding-left:0}.prose-sm thead th:last-child{padding-right:0}.prose-sm tbody td{padding:.6666667em 1em}.prose-sm tbody td:first-child{padding-left:0}.prose-sm tbody td:last-child{padding-right:0}.prose-sm>:first-child{margin-top:0}.prose-sm>:last-child{margin-bottom:0}.dark .dark\:prose-light{color:#e4e4e7}.dark .dark\:prose-light a{color:#fff}.dark .dark\:prose-light a:hover{color:#c084fc}.dark .dark\:prose-light strong{color:#fff}.dark .dark\:prose-light ol>li:before{color:#a1a1aa}.dark .dark\:prose-light ul>li:before{background-color:#52525b}.dark .dark\:prose-light hr{border-color:#e4e4e7}.dark .dark\:prose-light blockquote{color:#e4e4e7;border-left-color:#52525b}.dark .dark\:prose-light h1,.dark .dark\:prose-light h2,.dark .dark\:prose-light h3,.dark .dark\:prose-light h4{color:#fff}.dark .dark\:prose-light figure figcaption{color:#a1a1aa}.dark .dark\:prose-light a code,.dark .dark\:prose-light code{color:#fff}.dark .dark\:prose-light thead{color:#fff;border-bottom-color:#a1a1aa}.dark .dark\:prose-light tbody tr{border-bottom-color:#52525b}kbd{--tw-text-opacity:1;color:rgba(39,39,42,var(--tw-text-opacity));font-size:.875rem;line-height:1.25rem;--tw-bg-opacity:1;background-color:rgba(244,244,245,var(--tw-bg-opacity));--tw-border-opacity:1;border-color:rgba(161,161,170,var(--tw-border-opacity));border-width:1px;border-radius:.125rem;--tw-shadow:0 1px 3px 0 rgba(0,0,0,0.1),0 1px 2px 0 rgba(0,0,0,0.06);box-shadow:var(--tw-ring-offset-shadow,0 0 transparent),var(--tw-ring-shadow,0 0 transparent),var(--tw-shadow);padding-left:.25rem;padding-right:.25rem}.mx-4{margin-left:1rem;margin-right:1rem}.mx-auto{margin-left:auto;margin-right:auto}.my-3{margin-top:.75rem;margin-bottom:.75rem}.my-auto{margin-top:auto;margin-bottom:auto}.mt-1{margin-top:.25rem}.mr-2{margin-right:.5rem}.mr-3{margin-right:.75rem}.mr-4{margin-right:1rem}.mr-6{margin-right:1.5rem}.mb-2{margin-bottom:.5rem}.mb-3{margin-bottom:.75rem}.mb-4{margin-bottom:1rem}.mb-5{margin-bottom:1.25rem}.mb-8{margin-bottom:2rem}.mb-10{margin-bottom:2.5rem}.mb-14{margin-bottom:3.5rem}.mb-16{margin-bottom:4rem}.ml-1{margin-left:.25rem}.ml-2{margin-left:.5rem}.inline{display:inline}.flex{display:flex}.table{display:table}.grid{display:grid}.h-3{height:.75rem}.h-5{height:1.25rem}.min-h-screen{min-height:100vh}.w-3{width:.75rem}.w-5{width:1.25rem}.w-1\/2{width:50%}.max-w-sm{max-width:24rem}.max-w-2xl{max-width:42rem}.flex-none{flex:none}@keyframes spin{to{transform:rotate(1turn)}}@keyframes ping{75%,to{transform:scale(2);opacity:0}}@keyframes pulse{50%{opacity:.5}}@keyframes bounce{0%,to{transform:translateY(-25%);animation-timing-function:cubic-bezier(.8,0,1,1)}50%{transform:none;animation-timing-function:cubic-bezier(0,0,.2,1)}}@keyframes wiggle{0%,to{transform:rotate(0deg)}25%,75%{transform:rotate(15deg)}50%{transform:rotate(-15deg)}}.hover\:animate-wiggle:hover{animation:wiggle 3s ease-in-out infinite}.grid-flow-col{grid-auto-flow:column}.grid-cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}.flex-row{flex-direction:row}.flex-col{flex-direction:column}.flex-wrap{flex-wrap:wrap}.items-end{align-items:flex-end}.items-center{align-items:center}.justify-end{justify-content:flex-end}.justify-center{justify-content:center}.justify-between{justify-content:space-between}.justify-items-stretch{justify-items:stretch}.self-center{align-self:center}.rounded-lg{border-radius:.5rem}.border-4{border-width:4px}.border-b-4{border-bottom-width:4px}.border-b{border-bottom-width:1px}.dark .dark\:border-b-4{border-bottom-width:4px}.border-solid{border-style:solid}.border-dashed{border-style:dashed}.hover\:border-solid:hover{border-style:solid}.dark .dark\:border-double{border-style:double}.border-blue-800{--tw-border-opacity:1;border-color:rgba(30,64,175,var(--tw-border-opacity))}.dark .dark\:border-purple-400{--tw-border-opacity:1;border-color:rgba(192,132,252,var(--tw-border-opacity))}.bg-green-800{--tw-bg-opacity:1;background-color:rgba(22,101,52,var(--tw-bg-opacity))}.dark .dark\:bg-gray-800{--tw-bg-opacity:1;background-color:rgba(39,39,42,var(--tw-bg-opacity))}.fill-current{fill:currentColor}.object-cover{object-fit:cover}.p-6{padding:1.5rem}.p-10{padding:2.5rem}.px-1{padding-left:.25rem;padding-right:.25rem}.px-4{padding-left:1rem;padding-right:1rem}.px-6{padding-left:1.5rem;padding-right:1.5rem}.px-8{padding-left:2rem;padding-right:2rem}.py-4{padding-top:1rem;padding-bottom:1rem}.py-8{padding-top:2rem;padding-bottom:2rem}.py-12{padding-top:3rem;padding-bottom:3rem}.py-24{padding-top:6rem;padding-bottom:6rem}.pr-5{padding-right:1.25rem}.pb-4{padding-bottom:1rem}.pl-5{padding-left:1.25rem}.text-center{text-align:center}.text-right{text-align:right}.align-middle{vertical-align:middle}.text-xs{font-size:.75rem;line-height:1rem}.text-sm{font-size:.875rem;line-height:1.25rem}.text-xl{font-size:1.25rem;line-height:1.75rem}.text-3xl{font-size:1.875rem;line-height:2.25rem}.text-4xl{font-size:2.25rem;line-height:2.5rem}.text-5xl{font-size:3rem;line-height:1}.font-thin{font-weight:100}.font-light{font-weight:300}.font-semibold{font-weight:600}.font-bold{font-weight:700}.italic{font-style:italic}.tracking-tighter{letter-spacing:-.05em}.text-white{--tw-text-opacity:1;color:rgba(255,255,255,var(--tw-text-opacity))}.text-gray-400{--tw-text-opacity:1;color:rgba(161,161,170,var(--tw-text-opacity))}.text-gray-600{--tw-text-opacity:1;color:rgba(82,82,91,var(--tw-text-opacity))}.text-gray-700{--tw-text-opacity:1;color:rgba(63,63,70,var(--tw-text-opacity))}.text-gray-800{--tw-text-opacity:1;color:rgba(39,39,42,var(--tw-text-opacity))}.hover\:text-black:hover{--tw-text-opacity:1;color:rgba(0,0,0,var(--tw-text-opacity))}.hover\:text-purple-400:hover{--tw-text-opacity:1;color:rgba(192,132,252,var(--tw-text-opacity))}.group:hover .group-hover\:text-black{--tw-text-opacity:1;color:rgba(0,0,0,var(--tw-text-opacity))}.dark .dark\:text-white{--tw-text-opacity:1;color:rgba(255,255,255,var(--tw-text-opacity))}.dark .dark\:text-purple-400{--tw-text-opacity:1;color:rgba(192,132,252,var(--tw-text-opacity))}.dark .dark\:text-gray-300{--tw-text-opacity:1;color:rgba(212,212,216,var(--tw-text-opacity))}.dark .dark\:text-gray-400{--tw-text-opacity:1;color:rgba(161,161,170,var(--tw-text-opacity))}.dark .dark\:hover\:text-white:hover,.dark .group:hover .dark\:group-hover\:text-white{--tw-text-opacity:1;color:rgba(255,255,255,var(--tw-text-opacity))}.hover\:underline:hover,.underline{text-decoration:underline}*,:after,:before{--tw-shadow:0 0 transparent}.shadow-inner{--tw-shadow:inset 0 2px 4px 0 rgba(0,0,0,0.06);box-shadow:var(--tw-ring-offset-shadow,0 0 transparent),var(--tw-ring-shadow,0 0 transparent),var(--tw-shadow)}*,:after,:before{--tw-ring-inset:var(--tw-empty,/*!*/ /*!*/);--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgba(59,130,246,0.5);--tw-ring-offset-shadow:0 0 transparent;--tw-ring-shadow:0 0 transparent}.transition-colors{transition-property:background-color,border-color,color,fill,stroke;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:.15s}.duration-300{transition-duration:.3s}@media (min-width:640px){.sm\:px-6{padding-left:1.5rem;padding-right:1.5rem}.sm\:py-12{padding-top:3rem;padding-bottom:3rem}.sm\:text-sm{font-size:.875rem;line-height:1.25rem}}@media (min-width:768px){.md\:text-sm{font-size:.875rem;line-height:1.25rem}}@media (min-width:1024px){.lg\:mx-4{margin-left:1rem;margin-right:1rem}.lg\:max-w-3xl{max-width:48rem}.lg\:px-16{padding-left:4rem;padding-right:4rem}.lg\:py-16{padding-top:4rem;padding-bottom:4rem}.lg\:text-base{font-size:1rem;line-height:1.5rem}.lg\:text-2xl{font-size:1.5rem;line-height:2rem}.lg\:text-8xl{font-size:5rem}}@media (min-width:1280px){.xl\:mb-8{margin-bottom:2rem}.xl\:px-0{padding-left:0;padding-right:0}}@media (min-width:1536px){.\32xl\:max-w-4xl{max-width:56rem}}</style><meta name="generator" content="Gatsby 2.32.11"/><style type="text/css">
    .anchor.before {
      position: absolute;
      top: 0;
      left: 0;
      transform: translateX(-100%);
      padding-right: 4px;
    }
    .anchor.after {
      display: inline-block;
      padding-left: 4px;
    }
    h1 .anchor svg,
    h2 .anchor svg,
    h3 .anchor svg,
    h4 .anchor svg,
    h5 .anchor svg,
    h6 .anchor svg {
      visibility: hidden;
    }
    h1:hover .anchor svg,
    h2:hover .anchor svg,
    h3:hover .anchor svg,
    h4:hover .anchor svg,
    h5:hover .anchor svg,
    h6:hover .anchor svg,
    h1 .anchor:focus svg,
    h2 .anchor:focus svg,
    h3 .anchor:focus svg,
    h4 .anchor:focus svg,
    h5 .anchor:focus svg,
    h6 .anchor:focus svg {
      visibility: visible;
    }
  </style><script>
    document.addEventListener("DOMContentLoaded", function(event) {
      var hash = window.decodeURI(location.hash.replace('#', ''))
      if (hash !== '') {
        var element = document.getElementById(hash)
        if (element) {
          var scrollTop = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop
          var clientTop = document.documentElement.clientTop || document.body.clientTop || 0
          var offset = element.getBoundingClientRect().top + scrollTop - clientTop
          // Wait for the browser to finish rendering before scrolling.
          setTimeout((function() {
            window.scrollTo(0, offset - 0)
          }), 0)
        }
      }
    })
  </script><title data-react-helmet="true">Concurrent Ruby - Lazy Threads | TroyProg</title><meta data-react-helmet="true" content="In this post, we try to understand how the concurrent-ruby gem leverages Threads within its Async module. In a previous post, we began the process of learning…" name="description"/><meta data-react-helmet="true" content="Concurrent Ruby - Lazy Threads" property="og:title"/><meta data-react-helmet="true" content="In this post, we try to understand how the concurrent-ruby gem leverages Threads within its Async module. In a previous post, we began the process of learning…" property="og:description"/><meta data-react-helmet="true" content="website" property="og:type"/><meta data-react-helmet="true" content="summary" name="twitter:card"/><meta data-react-helmet="true" content="Troy Rosenberg (@tmr08c)" name="twitter:creator"/><meta data-react-helmet="true" content="Concurrent Ruby - Lazy Threads" name="twitter:title"/><meta data-react-helmet="true" content="In this post, we try to understand how the concurrent-ruby gem leverages Threads within its Async module. In a previous post, we began the process of learning…" name="twitter:description"/><link rel="icon" href="/favicon-32x32.png?v=b64c80c1072b59caa8281fdd06dd9925" type="image/png"/><link rel="manifest" href="/manifest.webmanifest" crossorigin="anonymous"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=b64c80c1072b59caa8281fdd06dd9925"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=b64c80c1072b59caa8281fdd06dd9925"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=b64c80c1072b59caa8281fdd06dd9925"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=b64c80c1072b59caa8281fdd06dd9925"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=b64c80c1072b59caa8281fdd06dd9925"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=b64c80c1072b59caa8281fdd06dd9925"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=b64c80c1072b59caa8281fdd06dd9925"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=b64c80c1072b59caa8281fdd06dd9925"/><link href="https://fonts.googleapis.com/css2?family=Chewy&amp;display=swap" rel="stylesheet"/><link as="script" rel="preload" href="/webpack-runtime-bbbb8b0884aed38140e0.js"/><link as="script" rel="preload" href="/framework-741ade27086b2708e961.js"/><link as="script" rel="preload" href="/styles-55e82d6ff5158c00b714.js"/><link as="script" rel="preload" href="/app-58da2f987d5d0aa08217.js"/><link as="script" rel="preload" href="/5265e14917706ae774eeedcf8740d96f07c711c9-27c52e43e6f8159c1a17.js"/><link as="script" rel="preload" href="/component---src-templates-blog-post-tsx-0bd3f76b3b3ee9c184dc.js"/><link as="fetch" rel="preload" href="/page-data/2020/09/concurrent-ruby-lazy-threads/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/3128451518.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/3649515864.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body><script>!function(e,a,t){function o(e){document.body.classList.add(e?"dark":"light"),document.body.classList.remove(e?"light":"dark")}var r=window.matchMedia("(prefers-color-scheme: dark)"),d="(prefers-color-scheme: dark)"===r.media,s=null;try{s=localStorage.getItem("darkMode")}catch(e){}var c=null!==s;if(c&&(s=JSON.parse(s)),c)o(s);else if(d)o(r.matches),localStorage.setItem("darkMode",r.matches);else{var l=document.body.classList.contains("dark");localStorage.setItem("darkMode",JSON.stringify(l))}}();</script><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div class="dark:bg-gray-800 dark:text-white"><nav class="flex items-center justify-between flex-wrap bg-green-800 px-6 py-12 mb-5 text-white dark:bg-gray-800 dark:border-b-4 dark:border-double dark:border-purple-400 dark:text-purple-400"><div class="flex flex-no-shrink"><a class="font-semibold text-4xl tracking-tighter hover:underline hover:animate-wiggle" href="/">TroyProg</a></div><div class="justify-end flex mr-4 text-xl items-center"><a class="mr-6 hover:text-black dark:hover:text-white" href="/talks">Talks</a><a class="mr-6 hover:text-black dark:hover:text-white" href="/blog">Blog</a><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" color="white" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" stroke="currentColor" style="cursor:pointer;transform:rotate(90deg)"><mask id="circle-mask-0"><rect x="0" y="0" width="100%" height="100%" fill="white"></rect><circle style="cx:100%;cy:0%" r="9" fill="black"></circle></mask><circle cx="12" cy="12" fill="white" style="r:5px" mask="url(#circle-mask-0)"></circle><g stroke="currentColor" style="opacity:1"><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></g></svg></div></nav><main class="min-h-screen mx-auto px-4 py-8 max-w-2xl sm:px-6 sm:py-12 lg:max-w-3xl lg:py-16 2xl:max-w-4xl xl:px-0"><article class="prose prose-sm sm:prose lg:prose-lg xl:prose-xl dark:prose-light"><h1>Concurrent Ruby - Lazy Threads</h1><div><p>In this post, we try to understand how the <a href="https://github.com/ruby-concurrency/concurrent-ruby" target="_blank" rel="nofollow noopener noreferrer"><code>concurrent-ruby</code></a> gem leverages <code>Thread</code>s within its <code>Async</code> module.</p>
<p>In a <a href="/2020/05/concurrent-ruby-hello-async/">previous post</a>, we began the process of learning about the <code>concurrent-ruby</code> gem. In that post, we started with the "hello, world" example provided in the <code>Async</code> module's <a href="http://ruby-concurrency.github.io/concurrent-ruby/master/Concurrent/Async.html" target="_blank" rel="nofollow noopener noreferrer">documentation</a> and made a few small tweaks to make the effects of <code>async</code> versus <code>await</code> obvious. We will now build on those foundations as we dive further into the <code>Async</code> module.</p>
<h2 id="our-test-setup" style="position:relative;"><a href="#our-test-setup" aria-label="our test setup permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Our Test Setup</h2>
<p>Before we get into how <code>Thread</code>s are used in the <code>Async</code> module, let's take a look at the code we will be using for testing.</p>
<p>Here is the file we will be working with:</p>
<pre class="grvsc-container tomorrow grvsc-ps-tJmpaV" data-language="ruby" data-index="0"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-10 grvsc-tJmpaV-10">require</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> </span><span class="grvsc-t564vY-7 grvsc-tJmpaV-7">&#39;bundler/inline&#39;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">gemfile </span><span class="grvsc-t564vY-11 grvsc-tJmpaV-11">do</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">  source </span><span class="grvsc-t564vY-7 grvsc-tJmpaV-7">&#39;https://rubygems.org&#39;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">  gem </span><span class="grvsc-t564vY-7 grvsc-tJmpaV-7">&#39;concurrent-ruby&#39;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-11 grvsc-tJmpaV-11">end</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-10 grvsc-tJmpaV-10">require</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> </span><span class="grvsc-t564vY-7 grvsc-tJmpaV-7">&#39;concurrent&#39;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-11 grvsc-tJmpaV-11">class</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> </span><span class="grvsc-t564vY-9 grvsc-tJmpaV-9">HelloAsync</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">  </span><span class="grvsc-t564vY-10 grvsc-tJmpaV-10">include</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> </span><span class="grvsc-t564vY-9 grvsc-tJmpaV-9">Concurrent</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">::</span><span class="grvsc-t564vY-8 grvsc-tJmpaV-8">Async</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">  </span><span class="grvsc-t564vY-11 grvsc-tJmpaV-11">def</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> </span><span class="grvsc-t564vY-10 grvsc-tJmpaV-10">hello_method</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">    </span><span class="grvsc-t564vY-10 grvsc-tJmpaV-10">sleep</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">(</span><span class="grvsc-t564vY-4 grvsc-tJmpaV-4">3</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">    </span><span class="grvsc-t564vY-10 grvsc-tJmpaV-10">puts</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> </span><span class="grvsc-t564vY-7 grvsc-tJmpaV-7">&quot;Hello! My object id is &#39;</span><span class="grvsc-t564vY-4 grvsc-tJmpaV-4">#{</span><span class="grvsc-t564vY-7 grvsc-tJmpaV-7">object_id</span><span class="grvsc-t564vY-4 grvsc-tJmpaV-4">}</span><span class="grvsc-t564vY-7 grvsc-tJmpaV-7">&#39; &quot;</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> \</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">         </span><span class="grvsc-t564vY-7 grvsc-tJmpaV-7">&quot;and I&#39;m running in thread &quot;</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> \</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">         </span><span class="grvsc-t564vY-7 grvsc-tJmpaV-7">&quot;&#39;</span><span class="grvsc-t564vY-4 grvsc-tJmpaV-4">#{</span><span class="grvsc-t564vY-9 grvsc-tJmpaV-9">Thread</span><span class="grvsc-t564vY-7 grvsc-tJmpaV-7">.current.object_id</span><span class="grvsc-t564vY-4 grvsc-tJmpaV-4">}</span><span class="grvsc-t564vY-7 grvsc-tJmpaV-7">&#39;.&quot;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">  </span><span class="grvsc-t564vY-11 grvsc-tJmpaV-11">end</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-11 grvsc-tJmpaV-11">end</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">hello_instance </span><span class="grvsc-t564vY-6 grvsc-tJmpaV-6">=</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> </span><span class="grvsc-t564vY-9 grvsc-tJmpaV-9">HelloAsync</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">.</span><span class="grvsc-t564vY-10 grvsc-tJmpaV-10">new</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-10 grvsc-tJmpaV-10">print</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> </span><span class="grvsc-t564vY-7 grvsc-tJmpaV-7">&#39;&gt; &#39;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-11 grvsc-tJmpaV-11">while</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> (input </span><span class="grvsc-t564vY-6 grvsc-tJmpaV-6">=</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> </span><span class="grvsc-t564vY-10 grvsc-tJmpaV-10">gets</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">  </span><span class="grvsc-t564vY-11 grvsc-tJmpaV-11">case</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> input</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">  </span><span class="grvsc-t564vY-11 grvsc-tJmpaV-11">when</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> </span><span class="grvsc-t564vY-8 grvsc-tJmpaV-8">/^</span><span class="grvsc-t564vY-5 grvsc-tJmpaV-5">[qQxX]</span><span class="grvsc-t564vY-8 grvsc-tJmpaV-8">/</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">    </span><span class="grvsc-t564vY-10 grvsc-tJmpaV-10">puts</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> </span><span class="grvsc-t564vY-7 grvsc-tJmpaV-7">&#39;Quitting...&#39;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">    </span><span class="grvsc-t564vY-10 grvsc-tJmpaV-10">exit</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">(</span><span class="grvsc-t564vY-4 grvsc-tJmpaV-4">0</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">  </span><span class="grvsc-t564vY-11 grvsc-tJmpaV-11">when</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> </span><span class="grvsc-t564vY-8 grvsc-tJmpaV-8">/^l(ist)?/</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">    </span><span class="grvsc-t564vY-10 grvsc-tJmpaV-10">puts</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> </span><span class="grvsc-t564vY-7 grvsc-tJmpaV-7">&quot;Currently have </span><span class="grvsc-t564vY-4 grvsc-tJmpaV-4">#{</span><span class="grvsc-t564vY-9 grvsc-tJmpaV-9">Thread</span><span class="grvsc-t564vY-7 grvsc-tJmpaV-7">.list.count</span><span class="grvsc-t564vY-4 grvsc-tJmpaV-4">}</span><span class="grvsc-t564vY-7 grvsc-tJmpaV-7"> threads.&quot;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">  </span><span class="grvsc-t564vY-11 grvsc-tJmpaV-11">when</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> </span><span class="grvsc-t564vY-8 grvsc-tJmpaV-8">/^async/</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">    hello_instance.async.hello_method</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">  </span><span class="grvsc-t564vY-11 grvsc-tJmpaV-11">when</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> </span><span class="grvsc-t564vY-8 grvsc-tJmpaV-8">/^await/</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">    hello_instance.await.hello_method</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">  </span><span class="grvsc-t564vY-11 grvsc-tJmpaV-11">when</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> </span><span class="grvsc-t564vY-8 grvsc-tJmpaV-8">/^new-async/</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">    </span><span class="grvsc-t564vY-9 grvsc-tJmpaV-9">HelloAsync</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">.</span><span class="grvsc-t564vY-10 grvsc-tJmpaV-10">new</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">.async.hello_method</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">  </span><span class="grvsc-t564vY-11 grvsc-tJmpaV-11">when</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> </span><span class="grvsc-t564vY-8 grvsc-tJmpaV-8">/^new-await/</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">    </span><span class="grvsc-t564vY-9 grvsc-tJmpaV-9">HelloAsync</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">.</span><span class="grvsc-t564vY-10 grvsc-tJmpaV-10">new</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">.await.hello_method</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">  </span><span class="grvsc-t564vY-11 grvsc-tJmpaV-11">else</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> </span><span class="grvsc-t564vY-10 grvsc-tJmpaV-10">puts</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> </span><span class="grvsc-t564vY-7 grvsc-tJmpaV-7">&quot;Received unknown input: </span><span class="grvsc-t564vY-4 grvsc-tJmpaV-4">#{</span><span class="grvsc-t564vY-7 grvsc-tJmpaV-7">input</span><span class="grvsc-t564vY-4 grvsc-tJmpaV-4">}</span><span class="grvsc-t564vY-7 grvsc-tJmpaV-7">&quot;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">  </span><span class="grvsc-t564vY-11 grvsc-tJmpaV-11">end</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">  </span><span class="grvsc-t564vY-10 grvsc-tJmpaV-10">print</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> </span><span class="grvsc-t564vY-7 grvsc-tJmpaV-7">&#39;&gt; &#39;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-11 grvsc-tJmpaV-11">end</span></span></span></code></pre>
<p>If this makes sense, feel free to <a href="#baseline">skip ahead</a> to the next section. Otherwise, read on for a breakdown of the code.</p>
<h3 id="dependencies" style="position:relative;"><a href="#dependencies" aria-label="dependencies permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Dependencies</h3>
<p>While we only have one gem we need for our script (<code>concurrent-ruby</code>, the gem we are testing), we also rely on <a href="https://bundler.io/" target="_blank" rel="nofollow noopener noreferrer">Bundler</a> for fetching this gem.</p>
<pre class="grvsc-container tomorrow grvsc-ps-tJmpaV" data-language="ruby" data-index="1"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-10 grvsc-tJmpaV-10">require</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> </span><span class="grvsc-t564vY-7 grvsc-tJmpaV-7">&#39;bundler/inline&#39;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">gemfile </span><span class="grvsc-t564vY-11 grvsc-tJmpaV-11">do</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">  source </span><span class="grvsc-t564vY-7 grvsc-tJmpaV-7">&#39;https://rubygems.org&#39;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">  gem </span><span class="grvsc-t564vY-7 grvsc-tJmpaV-7">&#39;concurrent-ruby&#39;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-11 grvsc-tJmpaV-11">end</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-10 grvsc-tJmpaV-10">require</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> </span><span class="grvsc-t564vY-7 grvsc-tJmpaV-7">&#39;concurrent&#39;</span></span></span></code></pre>
<p>With <a href="https://bundler.io/guides/bundler_in_a_single_file_ruby_script.html" target="_blank" rel="nofollow noopener noreferrer"><code>bundler/inline</code></a>, we define our <code>gemfile</code> in a block within the file. When running the script, if the gem isn't installed, Bundler will download it before proceeding.</p>
<h3 id="helloasync-class" style="position:relative;"><a href="#helloasync-class" aria-label="helloasync class permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><code>HelloAsync</code> Class</h3>
<p>This class is similar to what we created in the <a href="/2020/05/concurrent-ruby-hello-async/">previous post</a>. For more details on setting up a class to work with the <code>Concurrent::Async</code> module, please check out that post.</p>
<pre class="grvsc-container tomorrow grvsc-ps-tJmpaV" data-language="ruby" data-index="2"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-11 grvsc-tJmpaV-11">class</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> </span><span class="grvsc-t564vY-9 grvsc-tJmpaV-9">HelloAsync</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">  </span><span class="grvsc-t564vY-10 grvsc-tJmpaV-10">include</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> </span><span class="grvsc-t564vY-9 grvsc-tJmpaV-9">Concurrent</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">::</span><span class="grvsc-t564vY-8 grvsc-tJmpaV-8">Async</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">  </span><span class="grvsc-t564vY-11 grvsc-tJmpaV-11">def</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> </span><span class="grvsc-t564vY-10 grvsc-tJmpaV-10">hello_method</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">    </span><span class="grvsc-t564vY-10 grvsc-tJmpaV-10">sleep</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">(</span><span class="grvsc-t564vY-4 grvsc-tJmpaV-4">3</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">    </span><span class="grvsc-t564vY-10 grvsc-tJmpaV-10">puts</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> </span><span class="grvsc-t564vY-7 grvsc-tJmpaV-7">&quot;Hello! My object id is &#39;</span><span class="grvsc-t564vY-4 grvsc-tJmpaV-4">#{</span><span class="grvsc-t564vY-7 grvsc-tJmpaV-7">object_id</span><span class="grvsc-t564vY-4 grvsc-tJmpaV-4">}</span><span class="grvsc-t564vY-7 grvsc-tJmpaV-7">&#39; &quot;</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> \</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">         </span><span class="grvsc-t564vY-7 grvsc-tJmpaV-7">&quot;and I&#39;m running in thread &quot;</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> \</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">         </span><span class="grvsc-t564vY-7 grvsc-tJmpaV-7">&quot;&#39;</span><span class="grvsc-t564vY-4 grvsc-tJmpaV-4">#{</span><span class="grvsc-t564vY-9 grvsc-tJmpaV-9">Thread</span><span class="grvsc-t564vY-7 grvsc-tJmpaV-7">.current.object_id</span><span class="grvsc-t564vY-4 grvsc-tJmpaV-4">}</span><span class="grvsc-t564vY-7 grvsc-tJmpaV-7">&#39;.&quot;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">  </span><span class="grvsc-t564vY-11 grvsc-tJmpaV-11">end</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-11 grvsc-tJmpaV-11">end</span></span></span></code></pre>
<p>There are a few changes from our original implementation:</p>
<ul>
<li>The class has been renamed to <code>HelloAsync</code> and the method to <code>hello_method</code> to more easily differentiate between the class and method when writing about them.</li>
<li>
<p>The <code>puts</code> statement has been updated to add some additional information for our experimentation, including:</p>
<ul>
<li>The <code>object_id</code> for the current instance of the class. Since our REPL has an option for creating new objects (more on this below), this makes it possible to differentiate output between new and existing objects.</li>
<li>The <code>object_id</code> of the <a href="https://ruby-doc.org/core-2.5.0/Thread.html#method-c-current" target="_blank" rel="nofollow noopener noreferrer"><code>Thread</code> that the code is running in</a>. This helps us to identify whether we are in a new or existing <code>Thread</code>.</li>
</ul>
</li>
</ul>
<h3 id="command-options" style="position:relative;"><a href="#command-options" aria-label="command options permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Command Options</h3>
<p>This script creates a basic <a href="https://en.wikipedia.org/wiki/Read%E2%80%93eval%E2%80%93print_loop" target="_blank" rel="nofollow noopener noreferrer">REPL</a> that can handle a small set of commands:</p>
<pre class="grvsc-container tomorrow grvsc-ps-tJmpaV" data-language="ruby" data-index="3"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-11 grvsc-tJmpaV-11">while</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> (input </span><span class="grvsc-t564vY-6 grvsc-tJmpaV-6">=</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> </span><span class="grvsc-t564vY-10 grvsc-tJmpaV-10">gets</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">  </span><span class="grvsc-t564vY-11 grvsc-tJmpaV-11">case</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> input</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">  </span><span class="grvsc-t564vY-11 grvsc-tJmpaV-11">when</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> </span><span class="grvsc-t564vY-8 grvsc-tJmpaV-8">/^</span><span class="grvsc-t564vY-5 grvsc-tJmpaV-5">[qQxX]</span><span class="grvsc-t564vY-8 grvsc-tJmpaV-8">/</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">    </span><span class="grvsc-t564vY-10 grvsc-tJmpaV-10">puts</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> </span><span class="grvsc-t564vY-7 grvsc-tJmpaV-7">&#39;Quitting...&#39;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">    </span><span class="grvsc-t564vY-10 grvsc-tJmpaV-10">exit</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">(</span><span class="grvsc-t564vY-4 grvsc-tJmpaV-4">0</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">  </span><span class="grvsc-t564vY-11 grvsc-tJmpaV-11">when</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> </span><span class="grvsc-t564vY-8 grvsc-tJmpaV-8">/^l(ist)?/</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">    </span><span class="grvsc-t564vY-10 grvsc-tJmpaV-10">puts</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> </span><span class="grvsc-t564vY-7 grvsc-tJmpaV-7">&quot;Currently have </span><span class="grvsc-t564vY-4 grvsc-tJmpaV-4">#{</span><span class="grvsc-t564vY-9 grvsc-tJmpaV-9">Thread</span><span class="grvsc-t564vY-7 grvsc-tJmpaV-7">.list.count</span><span class="grvsc-t564vY-4 grvsc-tJmpaV-4">}</span><span class="grvsc-t564vY-7 grvsc-tJmpaV-7"> threads.&quot;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">  </span><span class="grvsc-t564vY-11 grvsc-tJmpaV-11">when</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> </span><span class="grvsc-t564vY-8 grvsc-tJmpaV-8">/^async/</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">    hello_instance.async.hello_method</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">  </span><span class="grvsc-t564vY-11 grvsc-tJmpaV-11">when</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> </span><span class="grvsc-t564vY-8 grvsc-tJmpaV-8">/^await/</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">    hello_instance.await.hello_method</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">  </span><span class="grvsc-t564vY-11 grvsc-tJmpaV-11">when</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> </span><span class="grvsc-t564vY-8 grvsc-tJmpaV-8">/^new-async/</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">    </span><span class="grvsc-t564vY-9 grvsc-tJmpaV-9">HelloAsync</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">.</span><span class="grvsc-t564vY-10 grvsc-tJmpaV-10">new</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">.async.hello_method</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">  </span><span class="grvsc-t564vY-11 grvsc-tJmpaV-11">when</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> </span><span class="grvsc-t564vY-8 grvsc-tJmpaV-8">/^new-await/</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">    </span><span class="grvsc-t564vY-9 grvsc-tJmpaV-9">HelloAsync</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">.</span><span class="grvsc-t564vY-10 grvsc-tJmpaV-10">new</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">.await.hello_method</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">  </span><span class="grvsc-t564vY-11 grvsc-tJmpaV-11">else</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> </span><span class="grvsc-t564vY-10 grvsc-tJmpaV-10">puts</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> </span><span class="grvsc-t564vY-7 grvsc-tJmpaV-7">&quot;Received unknown input: </span><span class="grvsc-t564vY-4 grvsc-tJmpaV-4">#{</span><span class="grvsc-t564vY-7 grvsc-tJmpaV-7">input</span><span class="grvsc-t564vY-4 grvsc-tJmpaV-4">}</span><span class="grvsc-t564vY-7 grvsc-tJmpaV-7">&quot;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">  </span><span class="grvsc-t564vY-11 grvsc-tJmpaV-11">end</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-11 grvsc-tJmpaV-11">end</span></span></span></code></pre>
<p>These options enable tracking the program's thread count while using various combinations of the <code>async</code> and <code>await</code> proxy methods. Let's cover them in more detail:</p>
<table>
<thead>
<tr>
<th>Command</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><kbd>q</kbd>, <kbd>x</kbd></td>
<td>Quit. Break out of the REPL and stop the script.</td>
</tr>
<tr>
<td><kbd>l</kbd>, <kbd>list</kbd></td>
<td>Print the number of <code>Thread</code>s the Ruby process knows about. Uses <a href="https://ruby-doc.org/core-2.5.0/Thread.html#method-c-list" target="_blank" rel="nofollow noopener noreferrer"><code>Thread.list</code></a>.</td>
</tr>
<tr>
<td><kbd>async</kbd></td>
<td>Run the <code>hello_method</code> method through the <code>async</code> proxy on an <strong>existing</strong> instance of the <code>HelloAsync</code> class.</td>
</tr>
<tr>
<td><kbd>new-async</kbd></td>
<td>Instantiates a <strong>new</strong> instance of the <code>HelloAsync</code> class and runs the <code>hello_method</code> method through the <code>async</code> proxy.</td>
</tr>
<tr>
<td><kbd>await</kbd></td>
<td>Run the <code>hello_method</code> method through the <code>await</code> proxy on an <strong>existing</strong> instance of the <code>HelloAsync</code> class.</td>
</tr>
<tr>
<td><kbd>new-await</kbd></td>
<td>Instantiates a <strong>new</strong> instance of the <code>HelloAsync</code> class and runs the <code>hello_method</code> method through the <code>await</code> proxy.</td>
</tr>
</tbody>
</table>
<h3 id="full-file" style="position:relative;"><a href="#full-file" aria-label="full file permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Full File</h3>
<p>Pulling it all together again, we have the following:</p>
<pre class="grvsc-container tomorrow grvsc-ps-tJmpaV" data-language="ruby" data-index="4"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-10 grvsc-tJmpaV-10">require</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> </span><span class="grvsc-t564vY-7 grvsc-tJmpaV-7">&#39;bundler/inline&#39;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">gemfile </span><span class="grvsc-t564vY-11 grvsc-tJmpaV-11">do</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">  source </span><span class="grvsc-t564vY-7 grvsc-tJmpaV-7">&#39;https://rubygems.org&#39;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">  gem </span><span class="grvsc-t564vY-7 grvsc-tJmpaV-7">&#39;concurrent-ruby&#39;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-11 grvsc-tJmpaV-11">end</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-10 grvsc-tJmpaV-10">require</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> </span><span class="grvsc-t564vY-7 grvsc-tJmpaV-7">&#39;concurrent&#39;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-11 grvsc-tJmpaV-11">class</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> </span><span class="grvsc-t564vY-9 grvsc-tJmpaV-9">HelloAsync</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">  </span><span class="grvsc-t564vY-10 grvsc-tJmpaV-10">include</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> </span><span class="grvsc-t564vY-9 grvsc-tJmpaV-9">Concurrent</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">::</span><span class="grvsc-t564vY-8 grvsc-tJmpaV-8">Async</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">  </span><span class="grvsc-t564vY-11 grvsc-tJmpaV-11">def</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> </span><span class="grvsc-t564vY-10 grvsc-tJmpaV-10">hello_method</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">    </span><span class="grvsc-t564vY-10 grvsc-tJmpaV-10">sleep</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">(</span><span class="grvsc-t564vY-4 grvsc-tJmpaV-4">3</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">    </span><span class="grvsc-t564vY-10 grvsc-tJmpaV-10">puts</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> </span><span class="grvsc-t564vY-7 grvsc-tJmpaV-7">&quot;Hello! My object id is &#39;</span><span class="grvsc-t564vY-4 grvsc-tJmpaV-4">#{</span><span class="grvsc-t564vY-7 grvsc-tJmpaV-7">object_id</span><span class="grvsc-t564vY-4 grvsc-tJmpaV-4">}</span><span class="grvsc-t564vY-7 grvsc-tJmpaV-7">&#39; &quot;</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> \</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">         </span><span class="grvsc-t564vY-7 grvsc-tJmpaV-7">&quot;and I&#39;m running in thread &quot;</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> \</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">         </span><span class="grvsc-t564vY-7 grvsc-tJmpaV-7">&quot;&#39;</span><span class="grvsc-t564vY-4 grvsc-tJmpaV-4">#{</span><span class="grvsc-t564vY-9 grvsc-tJmpaV-9">Thread</span><span class="grvsc-t564vY-7 grvsc-tJmpaV-7">.current.object_id</span><span class="grvsc-t564vY-4 grvsc-tJmpaV-4">}</span><span class="grvsc-t564vY-7 grvsc-tJmpaV-7">&#39;.&quot;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">  </span><span class="grvsc-t564vY-11 grvsc-tJmpaV-11">end</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-11 grvsc-tJmpaV-11">end</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">hello_instance </span><span class="grvsc-t564vY-6 grvsc-tJmpaV-6">=</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> </span><span class="grvsc-t564vY-9 grvsc-tJmpaV-9">HelloAsync</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">.</span><span class="grvsc-t564vY-10 grvsc-tJmpaV-10">new</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-10 grvsc-tJmpaV-10">print</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> </span><span class="grvsc-t564vY-7 grvsc-tJmpaV-7">&#39;&gt; &#39;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-11 grvsc-tJmpaV-11">while</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> (input </span><span class="grvsc-t564vY-6 grvsc-tJmpaV-6">=</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> </span><span class="grvsc-t564vY-10 grvsc-tJmpaV-10">gets</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">  </span><span class="grvsc-t564vY-11 grvsc-tJmpaV-11">case</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> input</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">  </span><span class="grvsc-t564vY-11 grvsc-tJmpaV-11">when</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> </span><span class="grvsc-t564vY-8 grvsc-tJmpaV-8">/^</span><span class="grvsc-t564vY-5 grvsc-tJmpaV-5">[qQxX]</span><span class="grvsc-t564vY-8 grvsc-tJmpaV-8">/</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">    </span><span class="grvsc-t564vY-10 grvsc-tJmpaV-10">puts</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> </span><span class="grvsc-t564vY-7 grvsc-tJmpaV-7">&#39;Quitting...&#39;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">    </span><span class="grvsc-t564vY-10 grvsc-tJmpaV-10">exit</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">(</span><span class="grvsc-t564vY-4 grvsc-tJmpaV-4">0</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">  </span><span class="grvsc-t564vY-11 grvsc-tJmpaV-11">when</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> </span><span class="grvsc-t564vY-8 grvsc-tJmpaV-8">/^l(ist)?/</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">    </span><span class="grvsc-t564vY-10 grvsc-tJmpaV-10">puts</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> </span><span class="grvsc-t564vY-7 grvsc-tJmpaV-7">&quot;Currently have </span><span class="grvsc-t564vY-4 grvsc-tJmpaV-4">#{</span><span class="grvsc-t564vY-9 grvsc-tJmpaV-9">Thread</span><span class="grvsc-t564vY-7 grvsc-tJmpaV-7">.list.count</span><span class="grvsc-t564vY-4 grvsc-tJmpaV-4">}</span><span class="grvsc-t564vY-7 grvsc-tJmpaV-7"> threads.&quot;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">  </span><span class="grvsc-t564vY-11 grvsc-tJmpaV-11">when</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> </span><span class="grvsc-t564vY-8 grvsc-tJmpaV-8">/^async/</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">    hello_instance.async.hello_method</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">  </span><span class="grvsc-t564vY-11 grvsc-tJmpaV-11">when</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> </span><span class="grvsc-t564vY-8 grvsc-tJmpaV-8">/^await/</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">    hello_instance.await.hello_method</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">  </span><span class="grvsc-t564vY-11 grvsc-tJmpaV-11">when</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> </span><span class="grvsc-t564vY-8 grvsc-tJmpaV-8">/^new-async/</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">    </span><span class="grvsc-t564vY-9 grvsc-tJmpaV-9">HelloAsync</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">.</span><span class="grvsc-t564vY-10 grvsc-tJmpaV-10">new</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">.async.hello_method</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">  </span><span class="grvsc-t564vY-11 grvsc-tJmpaV-11">when</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> </span><span class="grvsc-t564vY-8 grvsc-tJmpaV-8">/^new-await/</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">    </span><span class="grvsc-t564vY-9 grvsc-tJmpaV-9">HelloAsync</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">.</span><span class="grvsc-t564vY-10 grvsc-tJmpaV-10">new</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">.await.hello_method</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">  </span><span class="grvsc-t564vY-11 grvsc-tJmpaV-11">else</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> </span><span class="grvsc-t564vY-10 grvsc-tJmpaV-10">puts</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> </span><span class="grvsc-t564vY-7 grvsc-tJmpaV-7">&quot;Received unknown input: </span><span class="grvsc-t564vY-4 grvsc-tJmpaV-4">#{</span><span class="grvsc-t564vY-7 grvsc-tJmpaV-7">input</span><span class="grvsc-t564vY-4 grvsc-tJmpaV-4">}</span><span class="grvsc-t564vY-7 grvsc-tJmpaV-7">&quot;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">  </span><span class="grvsc-t564vY-11 grvsc-tJmpaV-11">end</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">  </span><span class="grvsc-t564vY-10 grvsc-tJmpaV-10">print</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> </span><span class="grvsc-t564vY-7 grvsc-tJmpaV-7">&#39;&gt; &#39;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-11 grvsc-tJmpaV-11">end</span></span></span></code></pre>
<p>If you are interested in trying this out for yourself, it's also available <a href="https://github.com/tmr08c/trying-concurrent-ruby/blob/master/01-hello-async.rb" target="_blank" rel="nofollow noopener noreferrer">on GitHub</a>.</p>
<h2 id="baseline" style="position:relative;"><a href="#baseline" aria-label="baseline permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Baseline</h2>
<p>When starting the REPL and printing out the thread count I see the following:</p>
<pre class="grvsc-container tomorrow grvsc-ps-tJmpaV" data-language="markup" data-index="5"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source">&gt; list</span></span>
<span class="grvsc-line"><span class="grvsc-source">Currently have 2 threads.</span></span></code></pre>
<p>I didn't <em>expect</em> two threads, but maybe Ruby leverages threads more than I thought. Let's compare this with an <code>irb</code> session:</p>
<pre class="grvsc-container tomorrow grvsc-ps-tJmpaV" data-language="ruby" data-index="6"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">irb</span><span class="grvsc-t564vY-6 grvsc-tJmpaV-6">&gt;</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> </span><span class="grvsc-t564vY-9 grvsc-tJmpaV-9">Thread</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">.list</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">=&gt; [</span><span class="grvsc-t564vY-3 grvsc-tJmpaV-3">#&lt;Thread:0x00007fbef585ffa0 run&gt;]</span></span></span></code></pre>
<p>Hmm, okay, it looks like we only have one thread. In the <code>irb</code> session I used <code>Thread.list</code> and dropped the <code>count</code>. I am going to temporarily drop the <code>count</code> in my script as well.</p>
<pre class="grvsc-container tomorrow grvsc-ps-tJmpaV" data-language="markup" data-index="7"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source">&gt; list</span></span>
<span class="grvsc-line"><span class="grvsc-source">Currently have [</span></span>
<span class="grvsc-line"><span class="grvsc-source">  #&lt;Thread:0x00007fdacc064010 run&gt;,</span></span>
<span class="grvsc-line"><span class="grvsc-source">  #&lt;Thread:0x00007fdacc100438@.../concurrent-ruby/concurrent/atomic/ruby_thread_local_var.rb:38 sleep_forever&gt;</span></span>
<span class="grvsc-line"><span class="grvsc-source">] threads.</span></span></code></pre>
<p>So we have the same "run" thread, but we also have a thread that looks like it's related to the <code>concurrent-ruby</code> gem.</p>
<h3 id="concurrent-ruby-initialize-thread" style="position:relative;"><a href="#concurrent-ruby-initialize-thread" aria-label="concurrent ruby initialize thread permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>concurrent-ruby Initialize Thread</h3>
<p>This other thread is created during the <code>require</code> process of the
<code>concurrent-ruby</code> gem (it looks like there is
<a href="https://github.com/ruby-concurrency/concurrent-ruby/issues/868" target="_blank" rel="nofollow noopener noreferrer">discussion</a> of
whether that is the right time to do this) as a part managing
<a href="https://ruby-concurrency.github.io/concurrent-ruby/1.1.5/Concurrent/ThreadLocalVar.html" target="_blank" rel="nofollow noopener noreferrer"><code>ThreadLocalVar</code></a>s.
This means that the additional thread is created <em>prior</em> to creating a new
instance of our <code>HelloAsync</code> class - it's created as soon as we <code>require 'concurrent'</code>.</p>
<p>We can reproduce this in <code>irb</code> as well:</p>
<pre class="grvsc-container tomorrow grvsc-ps-tJmpaV" data-language="ruby" data-index="8"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">irb</span><span class="grvsc-t564vY-6 grvsc-tJmpaV-6">&gt;</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> </span><span class="grvsc-t564vY-9 grvsc-tJmpaV-9">Thread</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">.list</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">=&gt; [</span><span class="grvsc-t564vY-3 grvsc-tJmpaV-3">#&lt;Thread:0x00007f912a85ffa8 run&gt;]</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">irb</span><span class="grvsc-t564vY-6 grvsc-tJmpaV-6">&gt;</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> </span><span class="grvsc-t564vY-10 grvsc-tJmpaV-10">require</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> </span><span class="grvsc-t564vY-7 grvsc-tJmpaV-7">&#39;concurrent&#39;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">=&gt; </span><span class="grvsc-t564vY-4 grvsc-tJmpaV-4">true</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">irb</span><span class="grvsc-t564vY-6 grvsc-tJmpaV-6">&gt;</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> </span><span class="grvsc-t564vY-9 grvsc-tJmpaV-9">Thread</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">.list</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">=&gt; [</span><span class="grvsc-t564vY-3 grvsc-tJmpaV-3">#&lt;Thread:0x00007f912a85ffa8 run&gt;,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">    </span><span class="grvsc-t564vY-3 grvsc-tJmpaV-3">#&lt;Thread:0x00007f91299453b0@.../concurrent-ruby/concurrent/atomic/ruby_thread_local_var.rb:38 sleep_forever&gt;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">]</span></span></span></code></pre>
<p>The implementation tracks and manages <code>ThreadLocalVar</code>s in a <a href="https://github.com/ruby-concurrency/concurrent-ruby/blob/082c05f136309fd7be56e7c1b07a4edcb93968f4/lib/concurrent-ruby/concurrent/atomic/ruby_thread_local_var.rb#L38-L39" target="_blank" rel="nofollow noopener noreferrer">long-running thread</a>. We haven't yet begun digging into the <a href="https://github.com/ruby-concurrency/concurrent-ruby#thread-safe-value-objects-structures-and-collections" target="_blank" rel="nofollow noopener noreferrer">thread-safe objects the library provides</a> yet, so we shouldn't need to worry too much about this additional thread.</p>
<p>The important things to note are:</p>
<ol>
<li>The baselines thread count is two.</li>
<li>The baseline does <strong>not</strong> include any threads created by the <code>HelloAsync</code> class.</li>
</ol>
<h3 id="multiple-rubies-support" style="position:relative;"><a href="#multiple-rubies-support" aria-label="multiple rubies support permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Multiple Rubies Support</h3>
<p>You may note that the file referenced in the thread is <code>ruby_thread_local_var.rb</code> and not just <code>thread_local_var.rb</code>. <code>ThreadLocalVar</code> has <a href="https://github.com/ruby-concurrency/concurrent-ruby/blob/082c05f136309fd7be56e7c1b07a4edcb93968f4/lib/concurrent-ruby/concurrent/atomic/thread_local_var.rb#L60-L65" target="_blank" rel="nofollow noopener noreferrer">implementations for Ruby and JRuby</a>. Since I am using MRI, I am seeing <code>RubyThreadLocalVar</code> and not <code>JavaThreadLocalVar</code>.</p>
<p>I mention this because there may be other instances where I reference the gem's MRI implementation, but you may see something different.</p>
<h2 id="our-first-or-third-thread" style="position:relative;"><a href="#our-first-or-third-thread" aria-label="our first or third thread permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Our first (or third) thread</h2>
<p>In our <a href="/2020/05/concurrent-ruby-hello-async/">previous post</a> we learned that the <code>await</code> method would create a new thread, run the method in the new thread, and return to the main thread; blocking our main thread the whole time. Does the thread stick around when it is done running the method?</p>
<pre class="grvsc-container tomorrow grvsc-ps-tJmpaV" data-language="markup" data-index="9"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source">&gt; await</span></span>
<span class="grvsc-line"><span class="grvsc-source">Hello! My object id is &#39;70161458709520&#39; \</span></span>
<span class="grvsc-line"><span class="grvsc-source">and I&#39;m running in thread &#39;70161462091140&#39;.</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">&gt; list</span></span>
<span class="grvsc-line"><span class="grvsc-source">Currently have 3 threads.</span></span></code></pre>
<p>It seems it does.</p>
<p>Does this mean that every time we use one of our proxy methods we are going to have extraneous threads that stick around?</p>
<pre class="grvsc-container tomorrow grvsc-ps-tJmpaV" data-language="markup" data-index="10"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source">&gt; await</span></span>
<span class="grvsc-line"><span class="grvsc-source">Hello! My object id is &#39;70161458709520&#39; \</span></span>
<span class="grvsc-line"><span class="grvsc-source">and I&#39;m running in thread &#39;70161462091140&#39;.</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">&gt; list</span></span>
<span class="grvsc-line"><span class="grvsc-source">Currently have 3 threads.</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">&gt; await</span></span>
<span class="grvsc-line"><span class="grvsc-source">Hello! My object id is &#39;70161458709520&#39; \</span></span>
<span class="grvsc-line"><span class="grvsc-source">and I&#39;m running in thread &#39;70161462091140&#39;.</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">&gt; list</span></span>
<span class="grvsc-line"><span class="grvsc-source">Currently have 3 threads.</span></span></code></pre>
<p>When running the <code>await</code> command multiple times, we are seeing the same object and thread IDs. The object ID makes sense since in our <a href="#command-options">REPL</a> we had the <code>await</code> command use the same object. However, the same thread ID wasn't something we intentionally set up.</p>
<p>This means we are <strong>reusing our thread</strong>. Rather than having threads created and left around, the library is reusing them for subsequent calls. This is great, as it helps save on the cost of starting up and maintaining a new thread.</p>
<h2 id="fancy-another" style="position:relative;"><a href="#fancy-another" aria-label="fancy another permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Fancy another</h2>
<p>So far, we've learned that <code>concurrent-ruby</code> will reuse our thread when calling <code>await</code> on the same instance of a class. What happens if we instantiate a new instance of our <code>HelloAsync</code> class? This is where the <a href="#command-options"><code>new-await</code> command</a> in our REPL comes into play.</p>
<pre class="grvsc-container tomorrow grvsc-ps-tJmpaV" data-language="markup" data-index="11"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source">&gt; await</span></span>
<span class="grvsc-line"><span class="grvsc-source">Hello! My object id is &#39;70161458709520&#39; \</span></span>
<span class="grvsc-line"><span class="grvsc-source">and I&#39;m running in thread &#39;70161462091140&#39;.</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">&gt; list</span></span>
<span class="grvsc-line"><span class="grvsc-source">Currently have 3 threads.</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">&gt; new-await</span></span>
<span class="grvsc-line"><span class="grvsc-source">Hello! My object id is &#39;70161462088680&#39; \</span></span>
<span class="grvsc-line"><span class="grvsc-source">and I&#39;m running in thread &#39;70161462091140&#39;.</span></span></code></pre>
<p>On closer inspection, we <em>are</em> seeing a new object ID, but the same thread ID:</p>
<pre class="grvsc-container grvsc-has-line-highlighting tomorrow grvsc-ps-tJmpaV" data-language="" data-index="12"><code class="grvsc-code"><span class="grvsc-line grvsc-line-diff grvsc-line-diff-del"><span class="grvsc-gutter-pad"></span><span class="grvsc-gutter grvsc-diff-del" aria-hidden="true" data-content="-"></span><span class="grvsc-source">Hello! My object id is &#39;70161458709520&#39; \</span></span>
<span class="grvsc-line"><span class="grvsc-gutter-pad"></span><span class="grvsc-gutter" aria-hidden="true"></span><span class="grvsc-source">and I&#39;m running in thread &#39;70161462091140&#39;.</span></span>
<span class="grvsc-line"><span class="grvsc-gutter-pad"></span><span class="grvsc-gutter" aria-hidden="true"></span><span class="grvsc-source"></span></span>
<span class="grvsc-line grvsc-line-diff grvsc-line-diff-add"><span class="grvsc-gutter-pad"></span><span class="grvsc-gutter grvsc-diff-add" aria-hidden="true" data-content="+"></span><span class="grvsc-source">Hello! My object id is &#39;70161462088680&#39; \</span></span>
<span class="grvsc-line"><span class="grvsc-gutter-pad"></span><span class="grvsc-gutter" aria-hidden="true"></span><span class="grvsc-source">and I&#39;m running in thread &#39;70161462091140&#39;.</span></span></code></pre>
<p>This indicates that <code>concurrent-ruby</code> will reuse threads, even across new instances of our <code>Async</code>-inheriting classes.</p>
<h2 id="what-are-you-awaiting-for" style="position:relative;"><a href="#what-are-you-awaiting-for" aria-label="what are you awaiting for permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>What are you (a)waiting for</h2>
<p>At this point, all of our tests have only used the <code>await</code> proxy method. Since this method will block our main thread until it's complete, we aren't sending multiple requests to multiple objects at a time. This does seem like it would make it easier to reuse the same thread. Do we see the same behavior with <code>async</code>?</p>
<p>Let's start with our <code>async</code> action. This will run the <code>hello_method</code> method through the <code>async</code> proxy on our existing instance of <code>HelloAsync</code>.</p>
<pre class="grvsc-container tomorrow grvsc-ps-tJmpaV" data-language="markup" data-index="13"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source">&gt; async</span></span>
<span class="grvsc-line"><span class="grvsc-source">Hello! My object id is &#39;70161458709520&#39; \</span></span>
<span class="grvsc-line"><span class="grvsc-source">and I&#39;m running in thread &#39;70161462091140&#39;.</span></span></code></pre>
<p>Since we are using our existing instance, it makes sense to see our same object ID. After what we've learned so far about thread reuse, it's not a complete surprise to see the same thread ID again either (despite a different proxy method being used).</p>
<p>As we mentioned above, since <code>async</code> doesn't block our main thread, we can call it multiple times. If we can get multiple calls to <code>async</code> queued up, should things be running concurrently through multiple threads?</p>
<pre class="grvsc-container tomorrow grvsc-ps-tJmpaV" data-language="markup" data-index="14"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source">&gt; async</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">&gt; list</span></span>
<span class="grvsc-line"><span class="grvsc-source">Currently have 3 threads.</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">&gt; async</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">&gt; list</span></span>
<span class="grvsc-line"><span class="grvsc-source">Currently have 3 threads.</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">&gt; async</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">Hello! My object id is &#39;70161458709520&#39; \</span></span>
<span class="grvsc-line"><span class="grvsc-source">and I&#39;m running in thread &#39;70161462091140&#39;.</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">&gt; list</span></span>
<span class="grvsc-line"><span class="grvsc-source">Currently have 3 threads.</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">&gt; async</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">&gt; list</span></span>
<span class="grvsc-line"><span class="grvsc-source">Currently have 3 threads.</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">Hello! My object id is &#39;70161458709520&#39; \</span></span>
<span class="grvsc-line"><span class="grvsc-source">and I&#39;m running in thread &#39;70161462091140&#39;.</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">&gt; list</span></span>
<span class="grvsc-line"><span class="grvsc-source">Currently have 3 threads.</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">Hello! My object id is &#39;70161458709520&#39; \</span></span>
<span class="grvsc-line"><span class="grvsc-source">and I&#39;m running in thread &#39;70161462091140&#39;.</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">&gt; list</span></span>
<span class="grvsc-line"><span class="grvsc-source">Currently have 3 threads.</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">Hello! My object id is &#39;70161458709520&#39; \</span></span>
<span class="grvsc-line"><span class="grvsc-source">and I&#39;m running in thread &#39;70161462091140&#39;.</span></span></code></pre>
<p>Above, we have multiple calls to <code>async</code> and <code>list</code>. The goal was to see if calling <code>async</code> multiple times before the method is completed (and we see our print statement) could increase our thread count. We seem to still be using our same object ID and thread ID, and never go above three threads. What's the deal? How are we going to do things concurrently if we don't spawn more threads?</p>
<h3 id="actors-and-mailboxes" style="position:relative;"><a href="#actors-and-mailboxes" aria-label="actors and mailboxes permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Actors and Mailboxes</h3>
<p>Because the <code>Async</code> module is modeling itself off of <a href="https://erlang.org/doc/man/gen_server.html" target="_blank" rel="nofollow noopener noreferrer"><code>gen_server</code></a>, it uses the <a href="https://en.wikipedia.org/wiki/Actor_model#Message-passing_semantics" target="_blank" rel="nofollow noopener noreferrer">message-passing semantics</a> of the Actor model.</p>
<p><a href="https://stackoverflow.com/a/10816216/2475008" target="_blank" rel="nofollow noopener noreferrer">This StackOverflow answer</a> from erlang co-creator Robert Virding explains what that means:</p>
<blockquote>
<p>All messages are placed in a process' message queue and processes handle their message one-by-one. If a message arrives while a process is busy then it is placed in the message queue.</p>
</blockquote>
<p>Staying true to their inspiration, <code>concurrent-ruby</code> follows a similar idea of queuing up the method calls an object receives. The object will then process (i.e., run) the methods one at a time. <a href="https://github.com/ruby-concurrency/concurrent-ruby/blob/082c05f136309fd7be56e7c1b07a4edcb93968f4/lib/concurrent-ruby/concurrent/async.rb#L323-L334" target="_blank" rel="nofollow noopener noreferrer">Here</a> is the relevant code in the gem:</p>
<pre class="grvsc-container tomorrow grvsc-ps-tJmpaV" data-language="ruby" data-index="15"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-3 grvsc-tJmpaV-3"># This is in the `AsyncDelegator`</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-3 grvsc-tJmpaV-3"># class defined within the `Async` module</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-11 grvsc-tJmpaV-11">def</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> </span><span class="grvsc-t564vY-10 grvsc-tJmpaV-10">method_missing</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">(</span><span class="grvsc-t564vY-4 grvsc-tJmpaV-4">method</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">, </span><span class="grvsc-t564vY-11 grvsc-tJmpaV-11">*</span><span class="grvsc-t564vY-4 grvsc-tJmpaV-4">args</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">, </span><span class="grvsc-t564vY-11 grvsc-tJmpaV-11">&amp;</span><span class="grvsc-t564vY-4 grvsc-tJmpaV-4">block</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">  </span><span class="grvsc-t564vY-11 grvsc-tJmpaV-11">super</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> </span><span class="grvsc-t564vY-11 grvsc-tJmpaV-11">unless</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> </span><span class="grvsc-t564vY-8 grvsc-tJmpaV-8">@delegate</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">.respond_to?(method)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">  </span><span class="grvsc-t564vY-9 grvsc-tJmpaV-9">Async</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">::validate_argc(</span><span class="grvsc-t564vY-8 grvsc-tJmpaV-8">@delegate</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">, method, </span><span class="grvsc-t564vY-6 grvsc-tJmpaV-6">*</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">args)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">  ivar </span><span class="grvsc-t564vY-6 grvsc-tJmpaV-6">=</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> </span><span class="grvsc-t564vY-9 grvsc-tJmpaV-9">Concurrent</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">::</span><span class="grvsc-t564vY-9 grvsc-tJmpaV-9">IVar</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">.</span><span class="grvsc-t564vY-10 grvsc-tJmpaV-10">new</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">  synchronize </span><span class="grvsc-t564vY-11 grvsc-tJmpaV-11">do</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">    </span><span class="grvsc-t564vY-8 grvsc-tJmpaV-8">@queue</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">.push [ivar, method, args, block]</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">    </span><span class="grvsc-t564vY-8 grvsc-tJmpaV-8">@executor</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">.post { perform } </span><span class="grvsc-t564vY-11 grvsc-tJmpaV-11">if</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> </span><span class="grvsc-t564vY-8 grvsc-tJmpaV-8">@queue</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">.length </span><span class="grvsc-t564vY-6 grvsc-tJmpaV-6">==</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> </span><span class="grvsc-t564vY-4 grvsc-tJmpaV-4">1</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">  </span><span class="grvsc-t564vY-11 grvsc-tJmpaV-11">end</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">  ivar</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-11 grvsc-tJmpaV-11">end</span></span></span></code></pre>
<p>Let's try to break this down. Before we get into this <code>method_missing</code> we have to learn a little bit more about the <code>Async</code> module.</p>
<p>The <code>Async</code> module defines <code>await</code> and <code>async</code> methods. Here is the <code>async</code> method:</p>
<pre class="grvsc-container tomorrow grvsc-ps-tJmpaV" data-language="ruby" data-index="16"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-11 grvsc-tJmpaV-11">def</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> </span><span class="grvsc-t564vY-10 grvsc-tJmpaV-10">async</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">  </span><span class="grvsc-t564vY-8 grvsc-tJmpaV-8">@__async_delegator__</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-11 grvsc-tJmpaV-11">end</span></span></span></code></pre>
<p>This returns an instance variable, <code>@__async_delegator__</code> which is created as a part of the initialization process. The <code>AsyncDelegator</code> is initialized by passing in <code>self</code>. <code>self</code> is the instance of the object that is <em>calling</em> the proxy method. In our case it is <code>hello_instance</code>, our <code>HelloAsync</code> object.</p>
<pre class="grvsc-container grvsc-has-line-highlighting tomorrow grvsc-ps-tJmpaV" data-language="ruby" data-index="17"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-11 grvsc-tJmpaV-11">def</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> </span><span class="grvsc-t564vY-10 grvsc-tJmpaV-10">init_synchronization</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">  </span><span class="grvsc-t564vY-11 grvsc-tJmpaV-11">return</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> </span><span class="grvsc-t564vY-8 grvsc-tJmpaV-8">self</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> </span><span class="grvsc-t564vY-11 grvsc-tJmpaV-11">if</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> </span><span class="grvsc-t564vY-11 grvsc-tJmpaV-11">defined?</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">(</span><span class="grvsc-t564vY-8 grvsc-tJmpaV-8">@__async_initialized__</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">) </span><span class="grvsc-t564vY-6 grvsc-tJmpaV-6">&amp;&amp;</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> </span><span class="grvsc-t564vY-8 grvsc-tJmpaV-8">@__async_initialized__</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">  </span><span class="grvsc-t564vY-8 grvsc-tJmpaV-8">@__async_initialized__</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> </span><span class="grvsc-t564vY-6 grvsc-tJmpaV-6">=</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> </span><span class="grvsc-t564vY-4 grvsc-tJmpaV-4">true</span></span></span>
<span class="grvsc-line grvsc-line-highlighted"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">  </span><span class="grvsc-t564vY-8 grvsc-tJmpaV-8">@__async_delegator__</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> </span><span class="grvsc-t564vY-6 grvsc-tJmpaV-6">=</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> </span><span class="grvsc-t564vY-9 grvsc-tJmpaV-9">AsyncDelegator</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">.</span><span class="grvsc-t564vY-10 grvsc-tJmpaV-10">new</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">(</span><span class="grvsc-t564vY-8 grvsc-tJmpaV-8">self</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">  </span><span class="grvsc-t564vY-8 grvsc-tJmpaV-8">@__await_delegator__</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> </span><span class="grvsc-t564vY-6 grvsc-tJmpaV-6">=</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> </span><span class="grvsc-t564vY-9 grvsc-tJmpaV-9">AwaitDelegator</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">.</span><span class="grvsc-t564vY-10 grvsc-tJmpaV-10">new</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">(</span><span class="grvsc-t564vY-8 grvsc-tJmpaV-8">@__async_delegator__</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">  </span><span class="grvsc-t564vY-8 grvsc-tJmpaV-8">self</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-11 grvsc-tJmpaV-11">end</span></span></span></code></pre>
<p>The <code>AsyncDelegator</code> class is defined within the <code>Async</code> module. This <code>AsyncDelegator</code> class includes the <code>method_missing</code> method we saw above.</p>
<p>Here's a reminder of what is happening when we type <code>async</code> into our REPL:</p>
<pre class="grvsc-container tomorrow grvsc-ps-tJmpaV" data-language="ruby" data-index="18"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">hello_instance </span><span class="grvsc-t564vY-6 grvsc-tJmpaV-6">=</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> </span><span class="grvsc-t564vY-9 grvsc-tJmpaV-9">HelloAsync</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">.</span><span class="grvsc-t564vY-10 grvsc-tJmpaV-10">new</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-3 grvsc-tJmpaV-3"># ...</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-11 grvsc-tJmpaV-11">when</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> </span><span class="grvsc-t564vY-8 grvsc-tJmpaV-8">/^async/</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> </span><span class="grvsc-t564vY-11 grvsc-tJmpaV-11">then</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> hello_instance.async.hello_method</span></span></span></code></pre>
<p>We call <code>async</code> on <code>hello_instance</code>. We now know this is giving us an <code>AsyncDelegator</code> that has a reference to our <code>hello_instance</code> object. We then call the method <code>hello_method</code>. However, we aren't calling it on <code>hello_instance</code> (our instance of the <code>HelloAsync</code> class) but instead on our instance of <code>AsyncDelegator</code> (<code>@__async_delegator__</code>). While we haven't looked at the <a href="https://github.com/ruby-concurrency/concurrent-ruby/blob/082c05f136309fd7be56e7c1b07a4edcb93968f4/lib/concurrent-ruby/concurrent/async.rb#L301-L364" target="_blank" rel="nofollow noopener noreferrer">whole <code>AsyncDelegator</code> class</a>, you can probably trust me that it doesn't define a <code>hello_method</code> method.</p>
<p><em>This</em> is where the <code>method_missing</code> from above comes into play. If you are unfamiliar with <a href="https://apidock.com/ruby/BasicObject/method_missing" target="_blank" rel="nofollow noopener noreferrer"><code>method_missing</code></a>, it is invoked when a method is called on an object and that object doesn't have a definition for that method. It is a powerful tool for metaprogramming and is enabling our <code>AsyncDelegator</code> to accept method calls without having to explicitly define them.</p>
<pre class="grvsc-container tomorrow grvsc-ps-tJmpaV" data-language="ruby" data-index="19"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-11 grvsc-tJmpaV-11">def</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> </span><span class="grvsc-t564vY-10 grvsc-tJmpaV-10">method_missing</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">(</span><span class="grvsc-t564vY-4 grvsc-tJmpaV-4">method</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">, </span><span class="grvsc-t564vY-11 grvsc-tJmpaV-11">*</span><span class="grvsc-t564vY-4 grvsc-tJmpaV-4">args</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">, </span><span class="grvsc-t564vY-11 grvsc-tJmpaV-11">&amp;</span><span class="grvsc-t564vY-4 grvsc-tJmpaV-4">block</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">)</span></span></span></code></pre>
<p>When we call <code>hello_instance.async.hello_method</code>, our <code>AsyncDelegator</code> (which doesn't define a <code>hello_method</code> method) will invoke <code>method_missing</code> and pass <code>hello_method</code> as the <code>method</code> argument. It will also pass any other arguments and a block if one is included.</p>
<p>After invoking <code>method_missing</code>, the library will do some validations. First, it will check if the "delegate" object (<code>hello_instance</code> in our case) defines the method we are calling. It will then check if the right number of arguments were passed in.</p>
<pre class="grvsc-container tomorrow grvsc-ps-tJmpaV" data-language="ruby" data-index="20"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-11 grvsc-tJmpaV-11">super</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> </span><span class="grvsc-t564vY-11 grvsc-tJmpaV-11">unless</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> </span><span class="grvsc-t564vY-8 grvsc-tJmpaV-8">@delegate</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">.respond_to?(method)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-9 grvsc-tJmpaV-9">Async</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">::validate_argc(</span><span class="grvsc-t564vY-8 grvsc-tJmpaV-8">@delegate</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">, method, </span><span class="grvsc-t564vY-6 grvsc-tJmpaV-6">*</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">args)</span></span></span></code></pre>
<p>After that, we create our <code>IVar</code>. In our <a href="/2020/05/concurrent-ruby-hello-async/">previous post</a> we took a surface-level look at <code>IVar</code>s and decided to not dig into them yet. We will do the same thing here, but note that the <code>IVar</code> is created, some stuff happens (which we will cover next), and then it is returned. This lines up with what we saw in our initial experimentation - we <a href="/2020/05/concurrent-ruby-hello-async/#return-types">found</a> that when using our proxy methods the return value would be an <code>IVar</code> instead of what the original method was returning.</p>
<pre class="grvsc-container tomorrow grvsc-ps-tJmpaV" data-language="ruby" data-index="21"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">  </span><span class="grvsc-t564vY-3 grvsc-tJmpaV-3"># ...stuff from above</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">  ivar </span><span class="grvsc-t564vY-6 grvsc-tJmpaV-6">=</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> </span><span class="grvsc-t564vY-9 grvsc-tJmpaV-9">Concurrent</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">::</span><span class="grvsc-t564vY-9 grvsc-tJmpaV-9">IVar</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">.</span><span class="grvsc-t564vY-10 grvsc-tJmpaV-10">new</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">  </span><span class="grvsc-t564vY-3 grvsc-tJmpaV-3"># Hiding the good stuff for now</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">  ivar</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-11 grvsc-tJmpaV-11">end</span></span></span></code></pre>
<p>Next, comes the main functionality.</p>
<pre class="grvsc-container tomorrow grvsc-ps-tJmpaV" data-language="ruby" data-index="22"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">synchronize </span><span class="grvsc-t564vY-11 grvsc-tJmpaV-11">do</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">  </span><span class="grvsc-t564vY-8 grvsc-tJmpaV-8">@queue</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">.push [ivar, method, args, block]</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">  </span><span class="grvsc-t564vY-8 grvsc-tJmpaV-8">@executor</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">.post { perform } </span><span class="grvsc-t564vY-11 grvsc-tJmpaV-11">if</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> </span><span class="grvsc-t564vY-8 grvsc-tJmpaV-8">@queue</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">.length </span><span class="grvsc-t564vY-6 grvsc-tJmpaV-6">==</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> </span><span class="grvsc-t564vY-4 grvsc-tJmpaV-4">1</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-11 grvsc-tJmpaV-11">end</span></span></span></code></pre>
<p>The implementation of <code>synchronize</code> will vary by which type and version of Ruby you are running, but is a mechanism for working with locks. It will check if the thread has access to the lock before <code>yield</code>ing and running whatever is in the block.</p>
<p>Once we have synchronized, we add an array of information to <code>@queue</code>.   <code>@queue</code> is an array that is created in our initialization process and is the equivalent of the "mailbox" concept from erlang.</p>
<p>We are adding the <code>ivar</code>, <code>method</code>, and the method's arguments and block to the queue. This is everything that is needed to run our method and put the results in an <code>IVar</code> to be consumed later. We will then <code>post</code> a block to our <code>@executor</code>.</p>
<p>Finding the <code>@executor</code> is another chain of branching inheritance. For my version of MRI Ruby, I eventually got to <a href="https://github.com/ruby-concurrency/concurrent-ruby/blob/082c05f136309fd7be56e7c1b07a4edcb93968f4/lib/concurrent-ruby/concurrent/executor/ruby_executor_service.rb#L17-L25" target="_blank" rel="nofollow noopener noreferrer"><code>RubyExecutorService#post</code></a>. The <code>ExecutorService</code> classes is the abstraction for running your code in new threads. These classes take in the arbitrary code to run and handle interacting with threads.</p>
<p>Along the chain to the <code>RubyExecutorService</code>, one of the parent classes was <a href="https://www.rubydoc.info/gems/concurrent-ruby/Concurrent/CachedThreadPool" target="_blank" rel="nofollow noopener noreferrer"><code>CachedThreadPool</code></a>. <strong>This class is key for many of the observations we have seen so far</strong>. From the docs:</p>
<blockquote>
<p>A thread pool that dynamically grows and shrinks to fit the current workload. New threads are created as needed, existing threads are reused, and threads that remain idle for too long are killed and removed from the pool.</p>
</blockquote>
<p>While this <code>CachedThreadPool</code> pool explains <em>some</em> of what we've seen, it doesn't fully explain why we aren't seeing the thread pool grow dynamically when we proxy through <code>async</code> multiple times. For that, we will need to look at the <code>perform</code> method in <code>AsyncDelegator</code>. This method is what is passed into our <code>@executor</code> to be run in a separate thread</p>
<pre class="grvsc-container tomorrow grvsc-ps-tJmpaV" data-language="ruby" data-index="23"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-3 grvsc-tJmpaV-3"># Async::AsyncDelegator</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-11 grvsc-tJmpaV-11">def</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> </span><span class="grvsc-t564vY-10 grvsc-tJmpaV-10">perform</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">  </span><span class="grvsc-t564vY-10 grvsc-tJmpaV-10">loop</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> </span><span class="grvsc-t564vY-11 grvsc-tJmpaV-11">do</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">    ivar, method, args, block </span><span class="grvsc-t564vY-6 grvsc-tJmpaV-6">=</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> synchronize { </span><span class="grvsc-t564vY-8 grvsc-tJmpaV-8">@queue</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">.first }</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">    </span><span class="grvsc-t564vY-11 grvsc-tJmpaV-11">break</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> </span><span class="grvsc-t564vY-11 grvsc-tJmpaV-11">unless</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> ivar </span><span class="grvsc-t564vY-3 grvsc-tJmpaV-3"># queue is empty</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">    </span><span class="grvsc-t564vY-11 grvsc-tJmpaV-11">begin</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">      ivar.set(</span><span class="grvsc-t564vY-8 grvsc-tJmpaV-8">@delegate</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">.send(method, </span><span class="grvsc-t564vY-6 grvsc-tJmpaV-6">*</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">args, </span><span class="grvsc-t564vY-6 grvsc-tJmpaV-6">&amp;</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">block))</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">    </span><span class="grvsc-t564vY-11 grvsc-tJmpaV-11">rescue</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> =&gt; error</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">      ivar.</span><span class="grvsc-t564vY-10 grvsc-tJmpaV-10">fail</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">(error)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">    </span><span class="grvsc-t564vY-11 grvsc-tJmpaV-11">end</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">    synchronize </span><span class="grvsc-t564vY-11 grvsc-tJmpaV-11">do</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">      </span><span class="grvsc-t564vY-8 grvsc-tJmpaV-8">@queue</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">.shift</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">      </span><span class="grvsc-t564vY-11 grvsc-tJmpaV-11">return</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> </span><span class="grvsc-t564vY-11 grvsc-tJmpaV-11">if</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> </span><span class="grvsc-t564vY-8 grvsc-tJmpaV-8">@queue</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">.empty?</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">    </span><span class="grvsc-t564vY-11 grvsc-tJmpaV-11">end</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">  </span><span class="grvsc-t564vY-11 grvsc-tJmpaV-11">end</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-11 grvsc-tJmpaV-11">end</span></span></span></code></pre>
<p><code>perform</code> is passed into the <code>@executor</code> and, when invoked, will loop until the <code>@queue</code> is empty. Each iteration of the loop will run the method originally called and update the <code>ivar</code>.</p>
<p>So, why do we need the <code>if</code> on the following line?</p>
<pre class="grvsc-container tomorrow grvsc-ps-tJmpaV" data-language="ruby" data-index="24"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="grvsc-t564vY-8 grvsc-tJmpaV-8">@executor</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">.post { perform } </span><span class="grvsc-t564vY-11 grvsc-tJmpaV-11">if</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> </span><span class="grvsc-t564vY-8 grvsc-tJmpaV-8">@queue</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1">.length </span><span class="grvsc-t564vY-6 grvsc-tJmpaV-6">==</span><span class="grvsc-t564vY-1 grvsc-tJmpaV-1"> </span><span class="grvsc-t564vY-4 grvsc-tJmpaV-4">1</span></span></span></code></pre>
<p>If <code>@queue</code> isn't empty, the <code>executor</code> would still be in the <code>loop</code> in <code>perform</code>. When we mutate the <code>@queue</code> by calling the <code>push</code> method it is updated everywhere, so our <code>loop</code> will have access to the new element pushed onto the queue. This explains the need to <code>synchronize</code> - when mutating the state of <code>@queue</code> we need to lock first because we could be updating it in our main thread (when we add to it by calling the method through the proxy) or in our <code>@executor</code> thread (in the <code>perform</code> loop when we <code>shift</code> elements off of the queue).</p>
<p>This shows how the <code>gen_server</code>-style FIFO message queue is implemented in the <code>Async</code> module.</p>
<ul>
<li>An <code>AsyncDelegator</code> instance has an instance variable <code>@queue</code> that is an array and stores everything needed to run the method called.</li>
<li>This array is passed in to the <code>perform</code> method, through a thread pool, and finally to an executor thread that will eventually run our code.</li>
<li>In <code>perform</code> the thread will loop, executing the next method in the queue, until there is nothing left in the queue.</li>
</ul>
<h2 id="i-came-here-to-see-multiple-threads" style="position:relative;"><a href="#i-came-here-to-see-multiple-threads" aria-label="i came here to see multiple threads permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>I came here to see multiple threads</h2>
<p>So far, we've seen the efficiency of <code>CachedThreadPool</code> and the message queue implementation style of <code>gen_stage</code> and how this has resulted in no additional threads spawned. What does it take to make a new thread?</p>
<h3 id="can-we-spawn-one-now" style="position:relative;"><a href="#can-we-spawn-one-now" aria-label="can we spawn one now permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Can we spawn one, now</h3>
<p>We've already seen <code>CachedThreadPool</code> pool in action when working with new instances of the <code>HelloAsync</code> class through our <code>new-await</code> command <a href="#fancy-another">above</a>. It may not be surprising to find that <code>new-async</code> (when called when no other commands are running) behaves similarly:</p>
<pre class="grvsc-container tomorrow grvsc-ps-tJmpaV" data-language="markup" data-index="25"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source">&gt; new-async</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">&gt; list</span></span>
<span class="grvsc-line"><span class="grvsc-source">Currently have 3 threads.</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">Hello! My object id is &#39;70161458746800&#39; \</span></span>
<span class="grvsc-line"><span class="grvsc-source">and I&#39;m running in thread &#39;70161462091140&#39;.</span></span></code></pre>
<h3 id="okay-how-about-now" style="position:relative;"><a href="#okay-how-about-now" aria-label="okay how about now permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Okay, how about now</h3>
<p>So, again, <code>CachedThreadPool</code> can reuse threads across instances of our <code>HelloAsync</code> class. But if we re-read the class's description, we know that threads are created "as needed."</p>
<blockquote>
<p>New threads are created as needed, existing threads are reused, (...)</p>
</blockquote>
<p>So far, we haven't see the "as needed" case. What if we run <em>multiple</em> <code>new-async</code> commands? Since it's <code>async</code> we should be able to request them multiple times view our REPL and since each request goes to a new instance, there is no waiting in the queue.</p>
<pre class="grvsc-container tomorrow grvsc-ps-tJmpaV" data-language="markup" data-index="26"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source">&gt; new-async</span></span>
<span class="grvsc-line"><span class="grvsc-source">&gt; new-async</span></span>
<span class="grvsc-line"><span class="grvsc-source">&gt; new-async</span></span>
<span class="grvsc-line"><span class="grvsc-source">&gt; new-async</span></span>
<span class="grvsc-line"><span class="grvsc-source">&gt; new-async</span></span>
<span class="grvsc-line"><span class="grvsc-source">&gt; new-async</span></span>
<span class="grvsc-line"><span class="grvsc-source">&gt; new-async</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">&gt; list</span></span>
<span class="grvsc-line"><span class="grvsc-source">Currently have 9 threads.</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">Hello! My object id is &#39;70161189799440&#39; \</span></span>
<span class="grvsc-line"><span class="grvsc-source">and I&#39;m running in thread &#39;70161462091140&#39;.</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">Hello! My object id is &#39;70161189798560&#39; \</span></span>
<span class="grvsc-line"><span class="grvsc-source">and I&#39;m running in thread &#39;70161458745000&#39;.</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">Hello! My object id is &#39;70161458781960&#39; \\</span></span>
<span class="grvsc-line"><span class="grvsc-source">and I&#39;m running in thread &#39;70161458781240&#39;.</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">Hello! My object id is &#39;70161458780740&#39; \</span></span>
<span class="grvsc-line"><span class="grvsc-source">and I&#39;m running in thread &#39;70161458780020&#39;.</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">Hello! My object id is &#39;70161458779520&#39; \</span></span>
<span class="grvsc-line"><span class="grvsc-source">and I&#39;m running in thread &#39;70161458778800&#39;.</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">Hello! My object id is &#39;70161458778300&#39; \</span></span>
<span class="grvsc-line"><span class="grvsc-source">and I&#39;m running in thread &#39;70161458777580&#39;.</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">Hello! My object id is &#39;70161458777080&#39; \</span></span>
<span class="grvsc-line"><span class="grvsc-source">and I&#39;m running in thread &#39;70161458776360&#39;.</span></span></code></pre>
<p>At last! We've found a way to spawn more threads.</p>
<h2 id="conclusion" style="position:relative;"><a href="#conclusion" aria-label="conclusion permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Conclusion</h2>
<p>While we haven't <em>used</em> the <code>Async</code> module in any meaningful way yet, these simple thread count checks have begun to lead us through implementation details of the <code>concurrent-ruby</code> gem. Hopefully, this exploration has provided us with a better understanding and appreciation of the gem.</p>
<p>I initially set out expecting to see a lot of thread creation. Instead, I learned that, thanks to <code>concurrent-ruby</code>, threads can be lazy (in the best way!). While the message processing aspects of <code>gen_stage</code> (and therefore the <code>Async</code> module) played a role in the lack of needing to spawn as many threads, it was the abstractions provided by <code>concurrent-ruby</code> that helped make things seamless. Since I imagine most people reach for a gem like <code>concurrent-ruby</code> for performance reasons, it's great to know that it has your back.</p>
<p>If you're interested in trying out different ways to create threads with the <code>Async</code> module, the code for the REPL is available <a href="https://github.com/tmr08c/trying-concurrent-ruby/blob/master/01-hello-async.rb" target="_blank" rel="nofollow noopener noreferrer">on
GitHub</a>.</p>
<style class="grvsc-styles">
  .grvsc-container {
    overflow: auto;
    position: relative;
    -webkit-overflow-scrolling: touch;
    padding-top: 1rem;
    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));
    padding-bottom: 1rem;
    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));
    border-radius: 8px;
    border-radius: var(--grvsc-border-radius, 8px);
    font-feature-settings: normal;
    line-height: 1.4;
  }
  
  .grvsc-code {
    display: table;
  }
  
  .grvsc-line {
    display: table-row;
    box-sizing: border-box;
    width: 100%;
    position: relative;
  }
  
  .grvsc-line > * {
    position: relative;
  }
  
  .grvsc-gutter-pad {
    display: table-cell;
    padding-left: 0.75rem;
    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);
  }
  
  .grvsc-gutter {
    display: table-cell;
    -webkit-user-select: none;
    -moz-user-select: none;
    user-select: none;
  }
  
  .grvsc-gutter::before {
    content: attr(data-content);
  }
  
  .grvsc-source {
    display: table-cell;
    padding-left: 1.5rem;
    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));
    padding-right: 1.5rem;
    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));
  }
  
  .grvsc-source:empty::after {
    content: ' ';
    -webkit-user-select: none;
    -moz-user-select: none;
    user-select: none;
  }
  
  .grvsc-gutter + .grvsc-source {
    padding-left: 0.75rem;
    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);
  }
  
  /* Line transformer styles */
  
  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {
    content: ' ';
    position: absolute;
    width: 100%;
  }
  
  .grvsc-line-diff-add::before {
    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));
  }
  
  .grvsc-line-diff-del::before {
    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));
  }
  
  .grvsc-line-number {
    padding: 0 2px;
    text-align: right;
    opacity: 0.7;
  }
  
  .tomorrow {
    background-color: #FFFFFF;
    color: #4D4D4C;
  }
  .tomorrow .grvsc-t564vY-10 { color: #4271AE; }
  .tomorrow .grvsc-t564vY-1 { color: #4D4D4C; }
  .tomorrow .grvsc-t564vY-7 { color: #718C00; }
  .tomorrow .grvsc-t564vY-11 { color: #8959A8; }
  .tomorrow .grvsc-t564vY-9 { color: #C99E00; }
  .tomorrow .grvsc-t564vY-8 { color: #C82829; }
  .tomorrow .grvsc-t564vY-4 { color: #F5871F; }
  .tomorrow .grvsc-t564vY-6 { color: #3E999F; }
  .tomorrow .grvsc-t564vY-5 { color: #666969; }
  .tomorrow .grvsc-t564vY-3 { color: #8E908C; }
  .tomorrow .grvsc-line-highlighted::before {
    background-color: var(--grvsc-line-highlighted-background-color, rgba(0, 0, 0, 0.05));
    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(0, 0, 0, 0.2));
  }
  body.dark .grvsc-ps-tJmpaV {
    background-color: #1D1F21;
    color: #C5C8C6;
  }
  body.dark .grvsc-ps-tJmpaV .grvsc-tJmpaV-10 { color: #81A2BE; }
  body.dark .grvsc-ps-tJmpaV .grvsc-tJmpaV-1 { color: #C5C8C6; }
  body.dark .grvsc-ps-tJmpaV .grvsc-tJmpaV-7 { color: #B5BD68; }
  body.dark .grvsc-ps-tJmpaV .grvsc-tJmpaV-11 { color: #B294BB; }
  body.dark .grvsc-ps-tJmpaV .grvsc-tJmpaV-9 { color: #F0C674; }
  body.dark .grvsc-ps-tJmpaV .grvsc-tJmpaV-8 { color: #CC6666; }
  body.dark .grvsc-ps-tJmpaV .grvsc-tJmpaV-4 { color: #DE935F; }
  body.dark .grvsc-ps-tJmpaV .grvsc-tJmpaV-6 { color: #8ABEB7; }
  body.dark .grvsc-ps-tJmpaV .grvsc-tJmpaV-5 { color: #CED1CF; }
  body.dark .grvsc-ps-tJmpaV .grvsc-tJmpaV-3 { color: #969896; }
  body.dark .grvsc-ps-tJmpaV .grvsc-line-highlighted::before {
    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));
    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));
  }
</style></div></article><div class="flex justify-end text-xs md:text-sm text-gray-600 font-light italic mb-2 dark:text-gray-400"><time dateTime="September 10, 2020">September 10, 2020</time></div><hr class="mb-3"/><div class="text-center font-light text-sm md:text-sm text-gray-600 italic mb-10 xl:mb-8 dark:text-gray-300">Notice something wrong? Please consider<!-- --> <a href="https://github.com/tmr08c/tmr08c.github.io/tree/develop/content/blog//2020/09/concurrent-ruby-lazy-threads/index.md" target="_blank" rel="noopener noreferrer" class="underline hover:text-purple-400">proposing an edit</a> <!-- -->or<!-- --> <a href="https://github.com/tmr08c/tmr08c.github.io/issues" target="_blank" rel="noopener noreferrer" class="underline hover:text-purple-400">opening an issue</a>.</div><div class="text-gray-600 grid grid-flow-col grid-cols-3 justify-items-stretch align-middle items-center text-xs sm:text-sm lg:text-base dark:text-gray-300"><a rel="prev" class="flex flex-row hover:text-purple-400" href="/2020/08/initialize-hash-value-in-ruby/"><span class="self-center flex-none mr-2">←</span><span>Initial Hash Value in Ruby</span></a><a class="text-center hover:text-purple-400" href="/blog">- All Posts -</a><a rel="next" class="flex flex-row justify-right hover:text-purple-400" href="/2020/10/contributing-github-actions/"><span class="text-right">Contributing GitHub Actions</span><span class="self-center flex-none ml-2">→</span></a></div></main><div class="flex justify-between py-4 px-1 bg-green-800 text-white dark:bg-gray-800 dark:text-purple-400"><div class="flex flex-col pl-5 my-auto"><a class="hover:text-black dark:hover:text-white" href="/">Home</a><div class="group"><a href="https://github.com/tmr08c/" target="blank" class="group-hover:text-black dark:group-hover:text-white"><svg viewBox="0 0 16 16" class="w-5 h-5 inline fill-current"><path d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"></path></svg><span class="text-sm ml-1 group-hover:text-black dark:group-hover:text-white">@tmr08c</span></a></div></div><div class="flex flex-col items-end pr-5 my-auto"><a class="hover:text-black dark:hover:text-white" href="/talks">Talks</a><div class="flex items-center"><a class="mr-3 hover:text-black dark:hover:text-white" href="/rss.xml"><svg viewBox="0 0 461.432 461.432" class="h-3 w-3 fill-current"><defs></defs><path d="M125.896 398.928c0 33.683-27.308 60.999-61.022 60.999-33.684 0-61.006-27.316-61.006-60.999 0-33.729 27.322-61.038 61.006-61.038 33.714 0 61.022 27.308 61.022 61.038zM0 229.636c0 8.441 6.606 15.379 15.036 15.809 60.318 3.076 100.885 25.031 138.248 62.582 36.716 36.864 60.071 89.759 64.082 137.769.686 8.202 7.539 14.524 15.77 14.524h56.701c4.344 0 8.498-1.784 11.488-4.935a15.852 15.852 0 004.333-11.729c-8.074-158.152-130.669-278.332-289.013-286.23a15.846 15.846 0 00-11.709 4.344A15.848 15.848 0 000 173.247v56.389z"></path><path d="M0 73.411c0 8.51 6.713 15.482 15.216 15.819 194.21 7.683 350.315 161.798 358.098 355.879.34 8.491 7.32 15.208 15.818 15.208h56.457c4.297 0 8.408-1.744 11.393-4.834a15.857 15.857 0 004.441-11.552C453.181 199.412 261.024 9.27 16.38 1.121A15.844 15.844 0 004.838 5.568 15.842 15.842 0 000 16.954v56.457z"></path></svg></a><a class="hover:text-black dark:hover:text-white" href="/blog">Blog</a></div></div></div></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/2020/09/concurrent-ruby-lazy-threads/";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-f89c5f37b65dee400010.js"],"app":["/app-58da2f987d5d0aa08217.js"],"component---node-modules-gatsby-plugin-offline-app-shell-js":["/component---node-modules-gatsby-plugin-offline-app-shell-js-eec87b46525379af865f.js"],"component---src-pages-404-tsx":["/component---src-pages-404-tsx-c80cf52d870552117fe7.js"],"component---src-pages-blog-tsx":["/component---src-pages-blog-tsx-f80cf169c86e0405b6c0.js"],"component---src-pages-index-tsx":["/component---src-pages-index-tsx-f1d7dccc5989efa5fe38.js"],"component---src-pages-talks-tsx":["/component---src-pages-talks-tsx-1357f575ab66bbcfcbd0.js"],"component---src-templates-blog-post-tsx":["/component---src-templates-blog-post-tsx-0bd3f76b3b3ee9c184dc.js"]};/*]]>*/</script><script src="/polyfill-f89c5f37b65dee400010.js" nomodule=""></script><script src="/component---src-templates-blog-post-tsx-0bd3f76b3b3ee9c184dc.js" async=""></script><script src="/5265e14917706ae774eeedcf8740d96f07c711c9-27c52e43e6f8159c1a17.js" async=""></script><script src="/app-58da2f987d5d0aa08217.js" async=""></script><script src="/styles-55e82d6ff5158c00b714.js" async=""></script><script src="/framework-741ade27086b2708e961.js" async=""></script><script src="/webpack-runtime-bbbb8b0884aed38140e0.js" async=""></script></body></html>