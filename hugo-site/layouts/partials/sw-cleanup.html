<!-- Service Worker Cleanup for Safari users with cached Gatsby SW -->
<script>
(function() {
  'use strict';
  
  // Check if this is likely a Gatsby service worker issue
  var hasGatsbyError = false;
  
  // Look for Gatsby-specific errors in the console or network
  if (window.location.pathname === '/' || window.location.pathname === '') {
    // Check if we're getting 404s for Gatsby resources
    var gatsbyResources = ['page-data.json', 'app-', 'webpack-runtime-', 'component---'];
    hasGatsbyError = gatsbyResources.some(function(resource) {
      return document.documentElement.innerHTML.indexOf(resource) > -1;
    });
  }
  
  // Only run cleanup once per session unless we detect Gatsby errors
  if (!sessionStorage.getItem('sw-cleanup-done') || hasGatsbyError) {
    sessionStorage.setItem('sw-cleanup-done', 'true');
    
    var cleanupPromises = [];
    
    // Unregister all service workers
    if ('serviceWorker' in navigator) {
      var swPromise = navigator.serviceWorker.getRegistrations().then(function(registrations) {
        if (registrations.length > 0) {
          console.log('Found', registrations.length, 'service workers to unregister');
          return Promise.all(
            registrations.map(function(registration) {
              console.log('Unregistering SW:', registration.scope);
              return registration.unregister();
            })
          );
        }
      });
      cleanupPromises.push(swPromise);
    }
    
    // Clear all caches
    if ('caches' in window) {
      var cachePromise = caches.keys().then(function(cacheNames) {
        if (cacheNames.length > 0) {
          console.log('Found', cacheNames.length, 'caches to delete');
          return Promise.all(
            cacheNames.map(function(cacheName) {
              console.log('Deleting cache:', cacheName);
              return caches.delete(cacheName);
            })
          );
        }
      });
      cleanupPromises.push(cachePromise);
    }
    
    // Clear localStorage items that might be Gatsby-related
    try {
      var keysToRemove = [];
      for (var i = 0; i < localStorage.length; i++) {
        var key = localStorage.key(i);
        if (key && (key.indexOf('gatsby') > -1 || key.indexOf('___') > -1)) {
          keysToRemove.push(key);
        }
      }
      keysToRemove.forEach(function(key) {
        console.log('Removing localStorage key:', key);
        localStorage.removeItem(key);
      });
    } catch (e) {
      console.log('localStorage cleanup error:', e);
    }
    
    // Wait for all cleanup to complete then reload
    if (cleanupPromises.length > 0) {
      Promise.all(cleanupPromises).then(function() {
        console.log('Service worker cleanup complete, reloading...');
        // Force a hard reload to bypass any remaining cache
        window.location.reload(true);
      }).catch(function(error) {
        console.error('Cleanup error:', error);
        // Reload anyway
        window.location.reload(true);
      });
    }
  }
})();

// Listen for reload message from service worker
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.addEventListener('message', function(event) {
    if (event.data && event.data.type === 'RELOAD_PAGE') {
      console.log('Received reload message from service worker');
      window.location.reload(true);
    }
  });
  
  // Try to register our cleanup service worker if there are issues
  if (window.location.pathname === '/' || window.location.pathname === '') {
    navigator.serviceWorker.register('/sw.js').catch(function(error) {
      console.log('Could not register cleanup SW:', error);
    });
  }
}
</script>