{"componentChunkName":"component---src-templates-blog-post-tsx","path":"/2021/04/phoenix-app-in-iframe/","result":{"data":{"site":{"siteMetadata":{"repsitory":"https://github.com/tmr08c/tmr08c.github.io"}},"markdownRemark":{"id":"6e661daf-cf41-5787-aa25-40a174f03e7e","excerpt":"For a side project, I am working on building a Jira Connect application using Elixir and Phoenix. With a Connect application, your UI is rendered within Jira asâ€¦","html":"<p>For a side project, I am working on building a <a href=\"https://developer.atlassian.com/cloud/jira/platform/#atlassian-connect\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Jira Connect application</a> using <a href=\"https://elixir-lang.org/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Elixir</a> and <a href=\"https://www.phoenixframework.org/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Phoenix</a>. With a Connect application, your UI is rendered within Jira as though it is a part of Jira itself. This in-Jira UI rendering is supported by the use of <a href=\"https://developer.mozilla.org/en-US/docs/Web/HTML/Element/iframe\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><code>iframe</code>s</a>.</p>\n<p>To get this to work with my Phoenix application, I needed to:</p>\n<ol>\n<li>Update the <code>Content-Security-Policy</code> response headers to enable some pages to be embeddable in an <code>iframe</code></li>\n<li>Update the <code>SameSite</code> settings for the session cookie to allow the cookies to be used by a third-party</li>\n</ol>\n<p>In this post, I will cover how I accomplished both of these tasks.</p>\n<h2 id=\"content-security-policy\" style=\"position:relative;\"><a href=\"#content-security-policy\" aria-label=\"content security policy permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><code>Content-Security-Policy</code></h2>\n<p>The <a href=\"https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><code>Content-Security-Policy</code> headers</a> provide a mechanism for the server to tell the browser what content is safe to load. A common use case for this is to help prevent <a href=\"https://developer.mozilla.org/en-US/docs/Glossary/Cross-site_scripting\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">XSS attacks</a>\nby blocking all JavaScript not explicitly listed in the <code>Content-Security-Policy</code>.</p>\n<p>In this case, we want our server to tell the browser on which domain we approve rendering our <code>iframe</code>. For this, we use the <a href=\"https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy/frame-ancestors\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><code>frame-ancestors</code></a> directive.</p>\n<p>The <code>fame-ancestors</code> directive expects a list of sources (e.g., URLs) that should be allowed to render the content in an <code>iframe</code>. For the Connect application, I wanted to allow the <code>iframe</code> to be renderable in any cloud instance of Jira. To do this, I was able to leverage the ability to use wildcard matchers to match any subdomain of <code>atlassian.net</code> - <code>https://*.atlassian.net</code>.</p>\n<p>I also decided to include the <a href=\"https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy/frame-src\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><code>'self'</code></a> source. This source enables <code>iframe</code>s to be renderable when the <code>iframe</code>'s <code>src</code> matches the origin of the page that is rendering it. I am using this to enable manual testing. Depending on your needs and testing strategy, you may be able to remove it.</p>\n<p>With these two pieces in mind, my goal was to end up with a <code>Content-Security-Policy</code> header that matched:</p>\n<pre class=\"grvsc-container tomorrow grvsc-ps-tJmpaV\" data-language=\"html\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">Content-Security-Policy: frame-ancestors &#39;self&#39; https://*.atlassian.net</span></span></span></code></pre>\n<h3 id=\"allow-iframe-plug\" style=\"position:relative;\"><a href=\"#allow-iframe-plug\" aria-label=\"allow iframe plug permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Allow <code>iframe</code> Plug</h3>\n<p>To add this response header, we will take advantage of Phoenix's use of <a href=\"https://hexdocs.pm/phoenix/plug.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Plug</a>. Plug is a library that allows you to interact with HTTP requests and responses and makes up the core of Phoenix's HTTP lifecycle.</p>\n<h3 id=\"testing-the-plug\" style=\"position:relative;\"><a href=\"#testing-the-plug\" aria-label=\"testing the plug permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Testing the Plug</h3>\n<p>We can use the <a href=\"https://hexdocs.pm/plug/Plug.Test.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><code>Plug.Test</code></a> module to test-drive our new plug.</p>\n<pre class=\"grvsc-container tomorrow grvsc-ps-tJmpaV\" data-language=\"elixir\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-3 grvsc-tJmpaV-3\"># test/my_app_web/plugs/allow_iframe_test.exs</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-11 grvsc-tJmpaV-11\">defmodule</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> MyAppWeb.Plugs.AllowIframeTest </span><span class=\"grvsc-t564vY-11 grvsc-tJmpaV-11\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">  </span><span class=\"grvsc-t564vY-10 grvsc-tJmpaV-10\">use</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-8 grvsc-tJmpaV-8\">ExUnit</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">.</span><span class=\"grvsc-t564vY-8 grvsc-tJmpaV-8\">Case</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">, </span><span class=\"grvsc-t564vY-4 grvsc-tJmpaV-4\">async:</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-4 grvsc-tJmpaV-4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">  </span><span class=\"grvsc-t564vY-10 grvsc-tJmpaV-10\">use</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-8 grvsc-tJmpaV-8\">Plug</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">.</span><span class=\"grvsc-t564vY-8 grvsc-tJmpaV-8\">Test</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">  </span><span class=\"grvsc-t564vY-10 grvsc-tJmpaV-10\">alias</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-8 grvsc-tJmpaV-8\">MyAppWeb</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">.</span><span class=\"grvsc-t564vY-8 grvsc-tJmpaV-8\">Plugs</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">.</span><span class=\"grvsc-t564vY-8 grvsc-tJmpaV-8\">AllowIframe</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">  test </span><span class=\"grvsc-t564vY-7 grvsc-tJmpaV-7\">&quot;updates Content-Security-Policy headers&quot;</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-11 grvsc-tJmpaV-11\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">    </span><span class=\"grvsc-t564vY-3 grvsc-tJmpaV-3\"># Create a test connection</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">    conn </span><span class=\"grvsc-t564vY-6 grvsc-tJmpaV-6\">=</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">      conn(</span><span class=\"grvsc-t564vY-4 grvsc-tJmpaV-4\">:get</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">, </span><span class=\"grvsc-t564vY-7 grvsc-tJmpaV-7\">&quot;/hello&quot;</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">      </span><span class=\"grvsc-t564vY-3 grvsc-tJmpaV-3\"># Invoke the plug</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">      </span><span class=\"grvsc-t564vY-6 grvsc-tJmpaV-6\">|&gt;</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-8 grvsc-tJmpaV-8\">AllowIframe</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">.call(%{})</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">    </span><span class=\"grvsc-t564vY-3 grvsc-tJmpaV-3\"># Get the `Content-Security-Policy`</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">    </span><span class=\"grvsc-t564vY-3 grvsc-tJmpaV-3\"># from the response headers</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">    csp_headers </span><span class=\"grvsc-t564vY-6 grvsc-tJmpaV-6\">=</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">      </span><span class=\"grvsc-t564vY-8 grvsc-tJmpaV-8\">Enum</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">.find(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">        conn.resp_headers,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">        </span><span class=\"grvsc-t564vY-11 grvsc-tJmpaV-11\">fn</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> {header, </span><span class=\"grvsc-t564vY-3 grvsc-tJmpaV-3\">_value</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">} </span><span class=\"grvsc-t564vY-6 grvsc-tJmpaV-6\">-&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">          header </span><span class=\"grvsc-t564vY-6 grvsc-tJmpaV-6\">==</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-7 grvsc-tJmpaV-7\">&quot;content-security-policy&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">        </span><span class=\"grvsc-t564vY-11 grvsc-tJmpaV-11\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">      )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">    </span><span class=\"grvsc-t564vY-3 grvsc-tJmpaV-3\"># Confirm it includes the `frame-ancestors` directive</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">    </span><span class=\"grvsc-t564vY-3 grvsc-tJmpaV-3\"># with &#39;self&#39; and our Atlassian wildcard matcher</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">    assert(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">      csp_headers </span><span class=\"grvsc-t564vY-6 grvsc-tJmpaV-6\">==</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">        </span><span class=\"grvsc-t564vY-7 grvsc-tJmpaV-7\">&quot;content-security-policy&quot;</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">        </span><span class=\"grvsc-t564vY-7 grvsc-tJmpaV-7\">&quot;frame-ancestors &#39;self&#39; https://*.atlassian.net;&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">    )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">  </span><span class=\"grvsc-t564vY-11 grvsc-tJmpaV-11\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-11 grvsc-tJmpaV-11\">end</span></span></span></code></pre>\n<p>This test will create a <code>conn</code> and pass that into our soon-to-be plug. It then <code>assert</code>s that our <code>conn</code> will have response headers that include our expected <code>Content-Security-Policy</code> and <code>frame-ancestors</code> pairing.</p>\n<p>With a failing test in place, we can now create a plug that will make it pass.</p>\n<h3 id=\"creating-the-plug\" style=\"position:relative;\"><a href=\"#creating-the-plug\" aria-label=\"creating the plug permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Creating the Plug</h3>\n<p>To implement our <code>AllowIframe</code> plug, we will create a <a href=\"https://hexdocs.pm/phoenix/plug.html#module-plugs\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">module plug</a>.</p>\n<p>In our <code>call</code> function we will use <a href=\"https://hexdocs.pm/plug/Plug.Conn.html?#put_resp_header/3\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><code>put_resp_header/3</code></a> to update the response headers to include the <code>Content-Security-Policy</code> header with the <code>frame-ancestors</code> directive. The end result should look something like:</p>\n<pre class=\"grvsc-container grvsc-has-line-highlighting tomorrow grvsc-ps-tJmpaV\" data-language=\"elixir\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-3 grvsc-tJmpaV-3\"># lib/my_app_web/plugs/allow_iframe.ex</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-11 grvsc-tJmpaV-11\">defmodule</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> MyAppWebb.Plugs.AllowIframe </span><span class=\"grvsc-t564vY-11 grvsc-tJmpaV-11\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">  </span><span class=\"grvsc-t564vY-3 grvsc-tJmpaV-3\">@moduledoc &quot;&quot;&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-3 grvsc-tJmpaV-3\">  Allow rendering in iframes for Jira.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-3 grvsc-tJmpaV-3\">  Uses `Content-Security-Policy: fame-ancestors`</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-3 grvsc-tJmpaV-3\">  which limits where the app can be loaded as</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-3 grvsc-tJmpaV-3\">  an `iframe` to only specified hosts.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-3 grvsc-tJmpaV-3\">  &quot;&quot;&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">  </span><span class=\"grvsc-t564vY-10 grvsc-tJmpaV-10\">import</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-8 grvsc-tJmpaV-8\">Plug</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">.</span><span class=\"grvsc-t564vY-8 grvsc-tJmpaV-8\">Conn</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">  </span><span class=\"grvsc-t564vY-11 grvsc-tJmpaV-11\">def</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-10 grvsc-tJmpaV-10\">init</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">(</span><span class=\"grvsc-t564vY-3 grvsc-tJmpaV-3\">_</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">), </span><span class=\"grvsc-t564vY-4 grvsc-tJmpaV-4\">do:</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> %{}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">  </span><span class=\"grvsc-t564vY-11 grvsc-tJmpaV-11\">def</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-10 grvsc-tJmpaV-10\">call</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">(conn, </span><span class=\"grvsc-t564vY-3 grvsc-tJmpaV-3\">_opts</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">) </span><span class=\"grvsc-t564vY-11 grvsc-tJmpaV-11\">do</span></span></span>\n<span class=\"grvsc-line grvsc-line-highlighted\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">    put_resp_header(</span></span></span>\n<span class=\"grvsc-line grvsc-line-highlighted\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">      conn,</span></span></span>\n<span class=\"grvsc-line grvsc-line-highlighted\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">      </span><span class=\"grvsc-t564vY-7 grvsc-tJmpaV-7\">&quot;content-security-policy&quot;</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">,</span></span></span>\n<span class=\"grvsc-line grvsc-line-highlighted\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">      </span><span class=\"grvsc-t564vY-7 grvsc-tJmpaV-7\">&quot;frame-ancestors &#39;self&#39; https://*.atlassian.net;&quot;</span></span></span>\n<span class=\"grvsc-line grvsc-line-highlighted\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">    )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">  </span><span class=\"grvsc-t564vY-11 grvsc-tJmpaV-11\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-11 grvsc-tJmpaV-11\">end</span></span></span></code></pre>\n<h3 id=\"plugging-it-in\" style=\"position:relative;\"><a href=\"#plugging-it-in\" aria-label=\"plugging it in permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Plugging it In</h3>\n<p>For our use case, we are going to add our plug to the <a href=\"https://hexdocs.pm/phoenix/plug.html#router-plugs\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">router</a>. Router plugs allow us to manage their usage on a per-route level instead of a <a href=\"https://hexdocs.pm/phoenix/plug.html#controller-plugs\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">per-controller</a> or more <a href=\"https://hexdocs.pm/phoenix/plug.html#endpoint-plugs\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">global (endpoint)</a> basis.</p>\n<p>To use a plug in the <code>router</code>, it must be <a href=\"https://hexdocs.pm/phoenix/plug.html#router-plugs\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">included in a <code>pipeline</code></a>. Since we are building a Connect application, I decided to make a <code>pipeline</code> to group routes that will be renderable within the Jira UI.</p>\n<pre class=\"grvsc-container tomorrow grvsc-ps-tJmpaV\" data-language=\"elixir\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-3 grvsc-tJmpaV-3\"># a part of the Jira Connect application</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">pipeline </span><span class=\"grvsc-t564vY-4 grvsc-tJmpaV-4\">:jira</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-11 grvsc-tJmpaV-11\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">  plug </span><span class=\"grvsc-t564vY-8 grvsc-tJmpaV-8\">MyAppWeb</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">.</span><span class=\"grvsc-t564vY-8 grvsc-tJmpaV-8\">Plugs</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">.</span><span class=\"grvsc-t564vY-8 grvsc-tJmpaV-8\">AllowIframe</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-11 grvsc-tJmpaV-11\">end</span></span></span></code></pre>\n<p>I did not add this directly to the existing <code>browser</code> <code>pipeline</code> because I anticipated the need to have routes that would not be rendered within the Jira UI (and therefore not in an <code>iframe</code>). While your needs will be different, please remember the ability to render <code>iframe</code>s is limited for security purposes. I would suggest trying to limit the ability to display your application in an <code>iframe</code> as much as possible and allow access on an as-needed basis instead of defaulting to making it available.</p>\n<p>With the <code>pipeline</code> in place, I can group routes that will be rendered in the Jira Connect application together. To do this, I leverage Phoenix's <a href=\"https://hexdocs.pm/phoenix/routing.html#scoped-routes\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">scope</a> block. This groups all routes to be nested under <code>/jira</code>. This grouping allows us to enable our <code>AllowfIframe</code> plug for all of these routes at the same time.</p>\n<pre class=\"grvsc-container tomorrow grvsc-ps-tJmpaV\" data-language=\"elixir\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">scope </span><span class=\"grvsc-t564vY-7 grvsc-tJmpaV-7\">&quot;/jira&quot;</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">, </span><span class=\"grvsc-t564vY-8 grvsc-tJmpaV-8\">MyAppWeb</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">.</span><span class=\"grvsc-t564vY-8 grvsc-tJmpaV-8\">Jira</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">, </span><span class=\"grvsc-t564vY-4 grvsc-tJmpaV-4\">as:</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-4 grvsc-tJmpaV-4\">:jira</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-11 grvsc-tJmpaV-11\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">  pipe_through [</span><span class=\"grvsc-t564vY-4 grvsc-tJmpaV-4\">:browser</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">, </span><span class=\"grvsc-t564vY-4 grvsc-tJmpaV-4\">:jira</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">  live </span><span class=\"grvsc-t564vY-7 grvsc-tJmpaV-7\">&quot;/&quot;</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">, </span><span class=\"grvsc-t564vY-8 grvsc-tJmpaV-8\">PageLive</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">, </span><span class=\"grvsc-t564vY-4 grvsc-tJmpaV-4\">:index</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">  get </span><span class=\"grvsc-t564vY-7 grvsc-tJmpaV-7\">&quot;/issue/:id&quot;</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">, </span><span class=\"grvsc-t564vY-8 grvsc-tJmpaV-8\">IssueController</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">, </span><span class=\"grvsc-t564vY-4 grvsc-tJmpaV-4\">:show</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-11 grvsc-tJmpaV-11\">end</span></span></span></code></pre>\n<h2 id=\"cookies\" style=\"position:relative;\"><a href=\"#cookies\" aria-label=\"cookies permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Cookies</h2>\n<p>At this point, we can render our application within an <code>iframe</code> in Jira (or wherever you set your <code>frame-ancestors</code>). However, even though your application is renderable, you may find your application does not work quite right. For me, I found the application would repeatedly reload when trying to view a LiveView page. You may also see problems when interacting with forms or managing user-session information.</p>\n<p>The Phoenix server tried to log a message hinting at the problem:</p>\n<pre class=\"grvsc-container tomorrow grvsc-ps-tJmpaV\" data-language=\"log\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">[debug] LiveView session was misconfigured</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">or the user token is outdated.</span></span></span></code></pre>\n<p>This log message also included suggestions for resolving the issue. One of the recommendations was to make sure to include the <a href=\"https://hexdocs.pm/plug/Plug.CSRFProtection.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">CSRF token</a> in the HTML and the JavaScript used to connect the LiveView socket. When looking at the server logs, I notice the <code>_csrf_token</code> <em>was</em> included in the parameters when attempting to connect to the socket, but that it was changing with every page reload and socket reconnect attempt.</p>\n<p>After some digging, I eventually discovered that the cookie, which stores information like the CSRF token, was not getting set when loading the <code>iframe</code> from within Jira.</p>\n<p>Our cookie was not getting set because the default behavior for cookies is to be <a href=\"https://web.dev/samesite-cookies-explained/#what-are-first-party-and-third-party-cookies\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">first-party</a>, meaning they are only accessible on the same domain as the server. Since we are rendering our site in an <code>iframe</code> we are attempting to access the cookies for our application from an Atlassian/Jira domain. Working with cookies from a different domain is known as <a href=\"https://web.dev/samesite-cookies-explained/#what-are-first-party-and-third-party-cookies\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">third-party cookies</a>. For security reasons, browsers block this type of cookie by default.</p>\n<p>For your application to create cookies that can be accessible by a third party, the cookie must have the <a href=\"https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Set-Cookie/SameSite\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><code>SameSite</code></a> property set to <code>'None'</code>. When sending cookies to third parties, you must also set the <a href=\"https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Set-Cookie#Secure\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><code>Secure</code></a> property on the cookie; this indicates that the cookie should only be accessible when the requesting site is using <code>https</code>. For more information on the <code>SameSite</code> options when working with cookies check out <a href=\"https://web.dev/samesite-cookies-explained/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">this article</a>.</p>\n<h3 id=\"third-party-cookies-with-phoenix\" style=\"position:relative;\"><a href=\"#third-party-cookies-with-phoenix\" aria-label=\"third party cookies with phoenix permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Third Party Cookies with Phoenix</h3>\n<p>Phoenix has a <a href=\"https://hexdocs.pm/plug/Plug.Session.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><code>Plug.Session</code></a> that is responsible for handling session cookies and stores. While we added the plug that we created above into the router, this plug is an <a href=\"https://hexdocs.pm/phoenix/plug.html#endpoint-plugs\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Endpoint plug</a> that Phoenix created at project generation time. In your project's endpoint module (<code>lib/my_app_web/endpoint.ex</code>), you should have a line like:</p>\n<pre class=\"grvsc-container tomorrow grvsc-ps-tJmpaV\" data-language=\"elixir\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">plug </span><span class=\"grvsc-t564vY-8 grvsc-tJmpaV-8\">Plug</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">.</span><span class=\"grvsc-t564vY-8 grvsc-tJmpaV-8\">Session</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">, </span><span class=\"grvsc-t564vY-8 grvsc-tJmpaV-8\">@session_options</span></span></span></code></pre>\n<p>This file should also include a <a href=\"https://elixir-lang.org/getting-started/module-attributes.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">module attribute</a> named <code>@session_options</code>. On a recently generated Phoenix application, it should look like:</p>\n<pre class=\"grvsc-container tomorrow grvsc-ps-tJmpaV\" data-language=\"elixir\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-3 grvsc-tJmpaV-3\"># The session will be stored in the cookie and signed,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-3 grvsc-tJmpaV-3\"># this means its contents can be read but not tampered with.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-3 grvsc-tJmpaV-3\"># Set :encryption_salt if you would also like to encrypt it.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-8 grvsc-tJmpaV-8\">@session_options</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> [</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">  </span><span class=\"grvsc-t564vY-4 grvsc-tJmpaV-4\">store:</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-4 grvsc-tJmpaV-4\">:cookie</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">  </span><span class=\"grvsc-t564vY-4 grvsc-tJmpaV-4\">key:</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-7 grvsc-tJmpaV-7\">&quot;_my_app_key&quot;</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">  </span><span class=\"grvsc-t564vY-4 grvsc-tJmpaV-4\">signing_salt:</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-7 grvsc-tJmpaV-7\">&quot;Salt&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">]</span></span></span></code></pre>\n<p>This is where we can set the additional <a href=\"https://hexdocs.pm/plug/Plug.Session.html#module-options\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><code>Plug.Session</code> options</a>, including <code>:same_site</code> and <code>:secure</code>. Our <code>@session_options</code> should now look something lke:</p>\n<pre class=\"grvsc-container grvsc-has-line-highlighting tomorrow grvsc-ps-tJmpaV\" data-language=\"elixir\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-8 grvsc-tJmpaV-8\">@session_options</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> [</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">  </span><span class=\"grvsc-t564vY-4 grvsc-tJmpaV-4\">store:</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-4 grvsc-tJmpaV-4\">:cookie</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">  </span><span class=\"grvsc-t564vY-4 grvsc-tJmpaV-4\">key:</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-7 grvsc-tJmpaV-7\">&quot;_my_app_key&quot;</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">  </span><span class=\"grvsc-t564vY-4 grvsc-tJmpaV-4\">signing_salt:</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-7 grvsc-tJmpaV-7\">&quot;Salt&quot;</span></span></span>\n<span class=\"grvsc-line grvsc-line-highlighted\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">  </span><span class=\"grvsc-t564vY-4 grvsc-tJmpaV-4\">same_site:</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-7 grvsc-tJmpaV-7\">&quot;None&quot;</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">,</span></span></span>\n<span class=\"grvsc-line grvsc-line-highlighted\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">  </span><span class=\"grvsc-t564vY-4 grvsc-tJmpaV-4\">secure:</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-4 grvsc-tJmpaV-4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">]</span></span></span></code></pre>\n<h3 id=\"same-problem-different-environment\" style=\"position:relative;\"><a href=\"#same-problem-different-environment\" aria-label=\"same problem different environment permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Same Problem, Different Environment</h3>\n<p>With the cookie set up to be available as a third-party cookie, we should no longer see constant reloading when rendering our <code>iframe</code> on a third-party site. However, setting the <code>secure</code> option on our session cookie may cause us some problems in local development. The <code>secure</code> flag requires communication over HTTPS. For some browsers, this extends to <code>localhost</code> as well. The need for HTTPS means that you will likely now face the same issues you did when interacting with your app in an <code>iframe</code> in your local development environment.</p>\n<p>To allow my application's cookies to get set during local development, I decided to set up <a href=\"https://hexdocs.pm/phoenix/using_ssl.html#ssl-in-development\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">SSL in development</a>. While some browsers will warn about using self-signed certificates (even on localhost), I prefer this method over conditionally setting the <code>secure</code> attribute on the cookies. I worry that the divergence in options between development and production could lead to hard to reproduce bugs or accidentally setting less secure options in production.</p>\n<p>For local HTTPS development, Phoenix provides a <code>mix</code> task to generate self-signed certificates (<code>mix phx.gen.cert</code>). You can then update the application's <code>Endpoint</code> to serve <code>https</code> and use the self-signed certificates by updating <code>config/dev.exs</code>.</p>\n<pre class=\"grvsc-container tomorrow grvsc-ps-tJmpaV\" data-language=\"elixir\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-3 grvsc-tJmpaV-3\"># config/dev.exs</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">config </span><span class=\"grvsc-t564vY-4 grvsc-tJmpaV-4\">:my_app</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">, </span><span class=\"grvsc-t564vY-8 grvsc-tJmpaV-8\">MyAppWeb</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">.</span><span class=\"grvsc-t564vY-8 grvsc-tJmpaV-8\">Endpoint</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">  </span><span class=\"grvsc-t564vY-4 grvsc-tJmpaV-4\">https:</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> [</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">    </span><span class=\"grvsc-t564vY-4 grvsc-tJmpaV-4\">port:</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-4 grvsc-tJmpaV-4\">4000</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">    </span><span class=\"grvsc-t564vY-4 grvsc-tJmpaV-4\">cipher_suite:</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-4 grvsc-tJmpaV-4\">:strong</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">    </span><span class=\"grvsc-t564vY-4 grvsc-tJmpaV-4\">keyfile:</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-7 grvsc-tJmpaV-7\">&quot;priv/cert/selfsigned_key.pem&quot;</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">    </span><span class=\"grvsc-t564vY-4 grvsc-tJmpaV-4\">certfile:</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-7 grvsc-tJmpaV-7\">&quot;priv/cert/selfsigned.pem&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">  ],</span></span></span></code></pre>\n<p>Please reference the <a href=\"https://hexdocs.pm/phoenix/using_ssl.html#ssl-in-development\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Phoenix documentation</a> for the most up-to-date way to do this.</p>\n<p>If you write feature tests with a tool that relies on a headless browser, you will also need to update your <code>Endpoint</code> settings in <code>config/test.exs</code> to serve over <code>https</code>. These changes should be similar to the changes we made above for the <code>dev</code> environment.</p>\n<p>One additional change I need to make for testing was to tell <a href=\"https://chromedriver.chromium.org/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">ChromeDriver</a> that it was okay to interact with our self-signed, less secure certificates when interacting with <code>localhost</code>. ChromeDriver provides the <a href=\"https://stackoverflow.com/questions/50838882/how-to-enable-an-allow-insecure-localhost-flag-in-chrome-from-selenium\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><code>--allow-insecure-localhost</code> flag</a> to do just that.</p>\n<p>I am using <a href=\"https://github.com/elixir-wallaby/wallaby\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Wallaby</a> for testing and set this flag with the following config:</p>\n<pre class=\"grvsc-container tomorrow grvsc-ps-tJmpaV\" data-language=\"elixir\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-3 grvsc-tJmpaV-3\"># config/test.exs`</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">config </span><span class=\"grvsc-t564vY-4 grvsc-tJmpaV-4\">:wallaby</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">       </span><span class=\"grvsc-t564vY-4 grvsc-tJmpaV-4\">:chromedriver</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">       </span><span class=\"grvsc-t564vY-4 grvsc-tJmpaV-4\">capabilities:</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> %{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">         </span><span class=\"grvsc-t564vY-4 grvsc-tJmpaV-4\">chromeOptions:</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> %{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">           </span><span class=\"grvsc-t564vY-4 grvsc-tJmpaV-4\">args:</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> [</span><span class=\"grvsc-t564vY-7 grvsc-tJmpaV-7\">&quot;--allow-insecure-localhost&quot;</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">         }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">       }</span></span></span></code></pre>\n<p>Despite not being the norm, this setup has not had any problems (yet) and has had the advantage of working with the <code>secure</code> cookie settings.</p>\n<h2 id=\"conclusion\" style=\"position:relative;\"><a href=\"#conclusion\" aria-label=\"conclusion permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Conclusion</h2>\n<p>At this point, you should now be able to render your application within an <code>iframe</code>. If you copied the <code>Content-Security-Policy</code> exactly, you would be limited to self-served and Atlassian <code>iframe</code>s, but, hopefully, you will be able to tweak our <code>AllowIframe</code> plug to fit your application's needs.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .tomorrow {\n    background-color: #FFFFFF;\n    color: #4D4D4C;\n  }\n  .tomorrow .grvsc-t564vY-1 { color: #4D4D4C; }\n  .tomorrow .grvsc-t564vY-3 { color: #8E908C; }\n  .tomorrow .grvsc-t564vY-11 { color: #8959A8; }\n  .tomorrow .grvsc-t564vY-10 { color: #4271AE; }\n  .tomorrow .grvsc-t564vY-8 { color: #C82829; }\n  .tomorrow .grvsc-t564vY-4 { color: #F5871F; }\n  .tomorrow .grvsc-t564vY-7 { color: #718C00; }\n  .tomorrow .grvsc-t564vY-6 { color: #3E999F; }\n  .tomorrow .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(0, 0, 0, 0.05));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(0, 0, 0, 0.2));\n  }\n  body.dark .grvsc-ps-tJmpaV {\n    background-color: #1D1F21;\n    color: #C5C8C6;\n  }\n  body.dark .grvsc-ps-tJmpaV .grvsc-tJmpaV-1 { color: #C5C8C6; }\n  body.dark .grvsc-ps-tJmpaV .grvsc-tJmpaV-3 { color: #969896; }\n  body.dark .grvsc-ps-tJmpaV .grvsc-tJmpaV-11 { color: #B294BB; }\n  body.dark .grvsc-ps-tJmpaV .grvsc-tJmpaV-10 { color: #81A2BE; }\n  body.dark .grvsc-ps-tJmpaV .grvsc-tJmpaV-8 { color: #CC6666; }\n  body.dark .grvsc-ps-tJmpaV .grvsc-tJmpaV-4 { color: #DE935F; }\n  body.dark .grvsc-ps-tJmpaV .grvsc-tJmpaV-7 { color: #B5BD68; }\n  body.dark .grvsc-ps-tJmpaV .grvsc-tJmpaV-6 { color: #8ABEB7; }\n  body.dark .grvsc-ps-tJmpaV .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","frontmatter":{"title":"Running a Phoenix App in an iframe","date":"April 26, 2021"}}},"pageContext":{"slug":"/2021/04/phoenix-app-in-iframe/","previous":{"fields":{"slug":"/2021/03/99-bottles-elixir/"},"frontmatter":{"title":"Singing 99 Bottles of Elixir"}},"next":{"fields":{"slug":"/2021/05/using-mix-install/"},"frontmatter":{"title":"Using Mix.install"}}}},"staticQueryHashes":["3128451518","3649515864"]}