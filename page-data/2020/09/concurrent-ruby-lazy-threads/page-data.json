{"componentChunkName":"component---src-templates-blog-post-tsx","path":"/2020/09/concurrent-ruby-lazy-threads/","result":{"data":{"site":{"siteMetadata":{"repsitory":"https://github.com/tmr08c/tmr08c.github.io"}},"markdownRemark":{"id":"e156dd24-81e4-5350-bdb9-ea5f14ba1562","excerpt":"In this post, we try to understand how the concurrent-ruby gem leverages Threads within its Async module. In a previous post, we began the process of learningâ€¦","html":"<p>In this post, we try to understand how the <a href=\"https://github.com/ruby-concurrency/concurrent-ruby\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><code>concurrent-ruby</code></a> gem leverages <code>Thread</code>s within its <code>Async</code> module.</p>\n<p>In a <a href=\"/2020/05/concurrent-ruby-hello-async/\">previous post</a>, we began the process of learning about the <code>concurrent-ruby</code> gem. In that post, we started with the \"hello, world\" example provided in the <code>Async</code> module's <a href=\"http://ruby-concurrency.github.io/concurrent-ruby/master/Concurrent/Async.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">documentation</a> and made a few small tweaks to make the effects of <code>async</code> versus <code>await</code> obvious. We will now build on those foundations as we dive further into the <code>Async</code> module.</p>\n<h2 id=\"our-test-setup\" style=\"position:relative;\"><a href=\"#our-test-setup\" aria-label=\"our test setup permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Our Test Setup</h2>\n<p>Before we get into how <code>Thread</code>s are used in the <code>Async</code> module, let's take a look at the code we will be using for testing.</p>\n<p>Here is the file we will be working with:</p>\n<pre class=\"grvsc-container tomorrow grvsc-ps-tJmpaV\" data-language=\"ruby\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-10 grvsc-tJmpaV-10\">require</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-7 grvsc-tJmpaV-7\">&#39;bundler/inline&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">gemfile </span><span class=\"grvsc-t564vY-11 grvsc-tJmpaV-11\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">  source </span><span class=\"grvsc-t564vY-7 grvsc-tJmpaV-7\">&#39;https://rubygems.org&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">  gem </span><span class=\"grvsc-t564vY-7 grvsc-tJmpaV-7\">&#39;concurrent-ruby&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-11 grvsc-tJmpaV-11\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-10 grvsc-tJmpaV-10\">require</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-7 grvsc-tJmpaV-7\">&#39;concurrent&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-11 grvsc-tJmpaV-11\">class</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-9 grvsc-tJmpaV-9\">HelloAsync</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">  </span><span class=\"grvsc-t564vY-10 grvsc-tJmpaV-10\">include</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-9 grvsc-tJmpaV-9\">Concurrent</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">::</span><span class=\"grvsc-t564vY-8 grvsc-tJmpaV-8\">Async</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">  </span><span class=\"grvsc-t564vY-11 grvsc-tJmpaV-11\">def</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-10 grvsc-tJmpaV-10\">hello_method</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">    </span><span class=\"grvsc-t564vY-10 grvsc-tJmpaV-10\">sleep</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">(</span><span class=\"grvsc-t564vY-4 grvsc-tJmpaV-4\">3</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">    </span><span class=\"grvsc-t564vY-10 grvsc-tJmpaV-10\">puts</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-7 grvsc-tJmpaV-7\">&quot;Hello! My object id is &#39;</span><span class=\"grvsc-t564vY-4 grvsc-tJmpaV-4\">#{</span><span class=\"grvsc-t564vY-7 grvsc-tJmpaV-7\">object_id</span><span class=\"grvsc-t564vY-4 grvsc-tJmpaV-4\">}</span><span class=\"grvsc-t564vY-7 grvsc-tJmpaV-7\">&#39; &quot;</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> \\</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">         </span><span class=\"grvsc-t564vY-7 grvsc-tJmpaV-7\">&quot;and I&#39;m running in thread &quot;</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> \\</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">         </span><span class=\"grvsc-t564vY-7 grvsc-tJmpaV-7\">&quot;&#39;</span><span class=\"grvsc-t564vY-4 grvsc-tJmpaV-4\">#{</span><span class=\"grvsc-t564vY-9 grvsc-tJmpaV-9\">Thread</span><span class=\"grvsc-t564vY-7 grvsc-tJmpaV-7\">.current.object_id</span><span class=\"grvsc-t564vY-4 grvsc-tJmpaV-4\">}</span><span class=\"grvsc-t564vY-7 grvsc-tJmpaV-7\">&#39;.&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">  </span><span class=\"grvsc-t564vY-11 grvsc-tJmpaV-11\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-11 grvsc-tJmpaV-11\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">hello_instance </span><span class=\"grvsc-t564vY-6 grvsc-tJmpaV-6\">=</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-9 grvsc-tJmpaV-9\">HelloAsync</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">.</span><span class=\"grvsc-t564vY-10 grvsc-tJmpaV-10\">new</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-10 grvsc-tJmpaV-10\">print</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-7 grvsc-tJmpaV-7\">&#39;&gt; &#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-11 grvsc-tJmpaV-11\">while</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> (input </span><span class=\"grvsc-t564vY-6 grvsc-tJmpaV-6\">=</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-10 grvsc-tJmpaV-10\">gets</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">  </span><span class=\"grvsc-t564vY-11 grvsc-tJmpaV-11\">case</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> input</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">  </span><span class=\"grvsc-t564vY-11 grvsc-tJmpaV-11\">when</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-8 grvsc-tJmpaV-8\">/^</span><span class=\"grvsc-t564vY-5 grvsc-tJmpaV-5\">[qQxX]</span><span class=\"grvsc-t564vY-8 grvsc-tJmpaV-8\">/</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">    </span><span class=\"grvsc-t564vY-10 grvsc-tJmpaV-10\">puts</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-7 grvsc-tJmpaV-7\">&#39;Quitting...&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">    </span><span class=\"grvsc-t564vY-10 grvsc-tJmpaV-10\">exit</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">(</span><span class=\"grvsc-t564vY-4 grvsc-tJmpaV-4\">0</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">  </span><span class=\"grvsc-t564vY-11 grvsc-tJmpaV-11\">when</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-8 grvsc-tJmpaV-8\">/^l(ist)?/</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">    </span><span class=\"grvsc-t564vY-10 grvsc-tJmpaV-10\">puts</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-7 grvsc-tJmpaV-7\">&quot;Currently have </span><span class=\"grvsc-t564vY-4 grvsc-tJmpaV-4\">#{</span><span class=\"grvsc-t564vY-9 grvsc-tJmpaV-9\">Thread</span><span class=\"grvsc-t564vY-7 grvsc-tJmpaV-7\">.list.count</span><span class=\"grvsc-t564vY-4 grvsc-tJmpaV-4\">}</span><span class=\"grvsc-t564vY-7 grvsc-tJmpaV-7\"> threads.&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">  </span><span class=\"grvsc-t564vY-11 grvsc-tJmpaV-11\">when</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-8 grvsc-tJmpaV-8\">/^async/</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">    hello_instance.async.hello_method</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">  </span><span class=\"grvsc-t564vY-11 grvsc-tJmpaV-11\">when</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-8 grvsc-tJmpaV-8\">/^await/</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">    hello_instance.await.hello_method</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">  </span><span class=\"grvsc-t564vY-11 grvsc-tJmpaV-11\">when</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-8 grvsc-tJmpaV-8\">/^new-async/</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">    </span><span class=\"grvsc-t564vY-9 grvsc-tJmpaV-9\">HelloAsync</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">.</span><span class=\"grvsc-t564vY-10 grvsc-tJmpaV-10\">new</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">.async.hello_method</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">  </span><span class=\"grvsc-t564vY-11 grvsc-tJmpaV-11\">when</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-8 grvsc-tJmpaV-8\">/^new-await/</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">    </span><span class=\"grvsc-t564vY-9 grvsc-tJmpaV-9\">HelloAsync</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">.</span><span class=\"grvsc-t564vY-10 grvsc-tJmpaV-10\">new</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">.await.hello_method</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">  </span><span class=\"grvsc-t564vY-11 grvsc-tJmpaV-11\">else</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-10 grvsc-tJmpaV-10\">puts</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-7 grvsc-tJmpaV-7\">&quot;Received unknown input: </span><span class=\"grvsc-t564vY-4 grvsc-tJmpaV-4\">#{</span><span class=\"grvsc-t564vY-7 grvsc-tJmpaV-7\">input</span><span class=\"grvsc-t564vY-4 grvsc-tJmpaV-4\">}</span><span class=\"grvsc-t564vY-7 grvsc-tJmpaV-7\">&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">  </span><span class=\"grvsc-t564vY-11 grvsc-tJmpaV-11\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">  </span><span class=\"grvsc-t564vY-10 grvsc-tJmpaV-10\">print</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-7 grvsc-tJmpaV-7\">&#39;&gt; &#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-11 grvsc-tJmpaV-11\">end</span></span></span></code></pre>\n<p>If this makes sense, feel free to <a href=\"#baseline\">skip ahead</a> to the next section. Otherwise, read on for a breakdown of the code.</p>\n<h3 id=\"dependencies\" style=\"position:relative;\"><a href=\"#dependencies\" aria-label=\"dependencies permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Dependencies</h3>\n<p>While we only have one gem we need for our script (<code>concurrent-ruby</code>, the gem we are testing), we also rely on <a href=\"https://bundler.io/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Bundler</a> for fetching this gem.</p>\n<pre class=\"grvsc-container tomorrow grvsc-ps-tJmpaV\" data-language=\"ruby\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-10 grvsc-tJmpaV-10\">require</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-7 grvsc-tJmpaV-7\">&#39;bundler/inline&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">gemfile </span><span class=\"grvsc-t564vY-11 grvsc-tJmpaV-11\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">  source </span><span class=\"grvsc-t564vY-7 grvsc-tJmpaV-7\">&#39;https://rubygems.org&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">  gem </span><span class=\"grvsc-t564vY-7 grvsc-tJmpaV-7\">&#39;concurrent-ruby&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-11 grvsc-tJmpaV-11\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-10 grvsc-tJmpaV-10\">require</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-7 grvsc-tJmpaV-7\">&#39;concurrent&#39;</span></span></span></code></pre>\n<p>With <a href=\"https://bundler.io/guides/bundler_in_a_single_file_ruby_script.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><code>bundler/inline</code></a>, we define our <code>gemfile</code> in a block within the file. When running the script, if the gem isn't installed, Bundler will download it before proceeding.</p>\n<h3 id=\"helloasync-class\" style=\"position:relative;\"><a href=\"#helloasync-class\" aria-label=\"helloasync class permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><code>HelloAsync</code> Class</h3>\n<p>This class is similar to what we created in the <a href=\"/2020/05/concurrent-ruby-hello-async/\">previous post</a>. For more details on setting up a class to work with the <code>Concurrent::Async</code> module, please check out that post.</p>\n<pre class=\"grvsc-container tomorrow grvsc-ps-tJmpaV\" data-language=\"ruby\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-11 grvsc-tJmpaV-11\">class</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-9 grvsc-tJmpaV-9\">HelloAsync</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">  </span><span class=\"grvsc-t564vY-10 grvsc-tJmpaV-10\">include</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-9 grvsc-tJmpaV-9\">Concurrent</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">::</span><span class=\"grvsc-t564vY-8 grvsc-tJmpaV-8\">Async</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">  </span><span class=\"grvsc-t564vY-11 grvsc-tJmpaV-11\">def</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-10 grvsc-tJmpaV-10\">hello_method</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">    </span><span class=\"grvsc-t564vY-10 grvsc-tJmpaV-10\">sleep</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">(</span><span class=\"grvsc-t564vY-4 grvsc-tJmpaV-4\">3</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">    </span><span class=\"grvsc-t564vY-10 grvsc-tJmpaV-10\">puts</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-7 grvsc-tJmpaV-7\">&quot;Hello! My object id is &#39;</span><span class=\"grvsc-t564vY-4 grvsc-tJmpaV-4\">#{</span><span class=\"grvsc-t564vY-7 grvsc-tJmpaV-7\">object_id</span><span class=\"grvsc-t564vY-4 grvsc-tJmpaV-4\">}</span><span class=\"grvsc-t564vY-7 grvsc-tJmpaV-7\">&#39; &quot;</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> \\</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">         </span><span class=\"grvsc-t564vY-7 grvsc-tJmpaV-7\">&quot;and I&#39;m running in thread &quot;</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> \\</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">         </span><span class=\"grvsc-t564vY-7 grvsc-tJmpaV-7\">&quot;&#39;</span><span class=\"grvsc-t564vY-4 grvsc-tJmpaV-4\">#{</span><span class=\"grvsc-t564vY-9 grvsc-tJmpaV-9\">Thread</span><span class=\"grvsc-t564vY-7 grvsc-tJmpaV-7\">.current.object_id</span><span class=\"grvsc-t564vY-4 grvsc-tJmpaV-4\">}</span><span class=\"grvsc-t564vY-7 grvsc-tJmpaV-7\">&#39;.&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">  </span><span class=\"grvsc-t564vY-11 grvsc-tJmpaV-11\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-11 grvsc-tJmpaV-11\">end</span></span></span></code></pre>\n<p>There are a few changes from our original implementation:</p>\n<ul>\n<li>The class has been renamed to <code>HelloAsync</code> and the method to <code>hello_method</code> to more easily differentiate between the class and method when writing about them.</li>\n<li>\n<p>The <code>puts</code> statement has been updated to add some additional information for our experimentation, including:</p>\n<ul>\n<li>The <code>object_id</code> for the current instance of the class. Since our REPL has an option for creating new objects (more on this below), this makes it possible to differentiate output between new and existing objects.</li>\n<li>The <code>object_id</code> of the <a href=\"https://ruby-doc.org/core-2.5.0/Thread.html#method-c-current\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><code>Thread</code> that the code is running in</a>. This helps us to identify whether we are in a new or existing <code>Thread</code>.</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"command-options\" style=\"position:relative;\"><a href=\"#command-options\" aria-label=\"command options permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Command Options</h3>\n<p>This script creates a basic <a href=\"https://en.wikipedia.org/wiki/Read%E2%80%93eval%E2%80%93print_loop\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">REPL</a> that can handle a small set of commands:</p>\n<pre class=\"grvsc-container tomorrow grvsc-ps-tJmpaV\" data-language=\"ruby\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-11 grvsc-tJmpaV-11\">while</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> (input </span><span class=\"grvsc-t564vY-6 grvsc-tJmpaV-6\">=</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-10 grvsc-tJmpaV-10\">gets</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">  </span><span class=\"grvsc-t564vY-11 grvsc-tJmpaV-11\">case</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> input</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">  </span><span class=\"grvsc-t564vY-11 grvsc-tJmpaV-11\">when</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-8 grvsc-tJmpaV-8\">/^</span><span class=\"grvsc-t564vY-5 grvsc-tJmpaV-5\">[qQxX]</span><span class=\"grvsc-t564vY-8 grvsc-tJmpaV-8\">/</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">    </span><span class=\"grvsc-t564vY-10 grvsc-tJmpaV-10\">puts</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-7 grvsc-tJmpaV-7\">&#39;Quitting...&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">    </span><span class=\"grvsc-t564vY-10 grvsc-tJmpaV-10\">exit</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">(</span><span class=\"grvsc-t564vY-4 grvsc-tJmpaV-4\">0</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">  </span><span class=\"grvsc-t564vY-11 grvsc-tJmpaV-11\">when</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-8 grvsc-tJmpaV-8\">/^l(ist)?/</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">    </span><span class=\"grvsc-t564vY-10 grvsc-tJmpaV-10\">puts</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-7 grvsc-tJmpaV-7\">&quot;Currently have </span><span class=\"grvsc-t564vY-4 grvsc-tJmpaV-4\">#{</span><span class=\"grvsc-t564vY-9 grvsc-tJmpaV-9\">Thread</span><span class=\"grvsc-t564vY-7 grvsc-tJmpaV-7\">.list.count</span><span class=\"grvsc-t564vY-4 grvsc-tJmpaV-4\">}</span><span class=\"grvsc-t564vY-7 grvsc-tJmpaV-7\"> threads.&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">  </span><span class=\"grvsc-t564vY-11 grvsc-tJmpaV-11\">when</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-8 grvsc-tJmpaV-8\">/^async/</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">    hello_instance.async.hello_method</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">  </span><span class=\"grvsc-t564vY-11 grvsc-tJmpaV-11\">when</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-8 grvsc-tJmpaV-8\">/^await/</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">    hello_instance.await.hello_method</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">  </span><span class=\"grvsc-t564vY-11 grvsc-tJmpaV-11\">when</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-8 grvsc-tJmpaV-8\">/^new-async/</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">    </span><span class=\"grvsc-t564vY-9 grvsc-tJmpaV-9\">HelloAsync</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">.</span><span class=\"grvsc-t564vY-10 grvsc-tJmpaV-10\">new</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">.async.hello_method</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">  </span><span class=\"grvsc-t564vY-11 grvsc-tJmpaV-11\">when</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-8 grvsc-tJmpaV-8\">/^new-await/</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">    </span><span class=\"grvsc-t564vY-9 grvsc-tJmpaV-9\">HelloAsync</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">.</span><span class=\"grvsc-t564vY-10 grvsc-tJmpaV-10\">new</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">.await.hello_method</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">  </span><span class=\"grvsc-t564vY-11 grvsc-tJmpaV-11\">else</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-10 grvsc-tJmpaV-10\">puts</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-7 grvsc-tJmpaV-7\">&quot;Received unknown input: </span><span class=\"grvsc-t564vY-4 grvsc-tJmpaV-4\">#{</span><span class=\"grvsc-t564vY-7 grvsc-tJmpaV-7\">input</span><span class=\"grvsc-t564vY-4 grvsc-tJmpaV-4\">}</span><span class=\"grvsc-t564vY-7 grvsc-tJmpaV-7\">&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">  </span><span class=\"grvsc-t564vY-11 grvsc-tJmpaV-11\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-11 grvsc-tJmpaV-11\">end</span></span></span></code></pre>\n<p>These options enable tracking the program's thread count while using various combinations of the <code>async</code> and <code>await</code> proxy methods. Let's cover them in more detail:</p>\n<table>\n<thead>\n<tr>\n<th>Command</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><kbd>q</kbd>, <kbd>x</kbd></td>\n<td>Quit. Break out of the REPL and stop the script.</td>\n</tr>\n<tr>\n<td><kbd>l</kbd>, <kbd>list</kbd></td>\n<td>Print the number of <code>Thread</code>s the Ruby process knows about. Uses <a href=\"https://ruby-doc.org/core-2.5.0/Thread.html#method-c-list\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><code>Thread.list</code></a>.</td>\n</tr>\n<tr>\n<td><kbd>async</kbd></td>\n<td>Run the <code>hello_method</code> method through the <code>async</code> proxy on an <strong>existing</strong> instance of the <code>HelloAsync</code> class.</td>\n</tr>\n<tr>\n<td><kbd>new-async</kbd></td>\n<td>Instantiates a <strong>new</strong> instance of the <code>HelloAsync</code> class and runs the <code>hello_method</code> method through the <code>async</code> proxy.</td>\n</tr>\n<tr>\n<td><kbd>await</kbd></td>\n<td>Run the <code>hello_method</code> method through the <code>await</code> proxy on an <strong>existing</strong> instance of the <code>HelloAsync</code> class.</td>\n</tr>\n<tr>\n<td><kbd>new-await</kbd></td>\n<td>Instantiates a <strong>new</strong> instance of the <code>HelloAsync</code> class and runs the <code>hello_method</code> method through the <code>await</code> proxy.</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"full-file\" style=\"position:relative;\"><a href=\"#full-file\" aria-label=\"full file permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Full File</h3>\n<p>Pulling it all together again, we have the following:</p>\n<pre class=\"grvsc-container tomorrow grvsc-ps-tJmpaV\" data-language=\"ruby\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-10 grvsc-tJmpaV-10\">require</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-7 grvsc-tJmpaV-7\">&#39;bundler/inline&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">gemfile </span><span class=\"grvsc-t564vY-11 grvsc-tJmpaV-11\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">  source </span><span class=\"grvsc-t564vY-7 grvsc-tJmpaV-7\">&#39;https://rubygems.org&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">  gem </span><span class=\"grvsc-t564vY-7 grvsc-tJmpaV-7\">&#39;concurrent-ruby&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-11 grvsc-tJmpaV-11\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-10 grvsc-tJmpaV-10\">require</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-7 grvsc-tJmpaV-7\">&#39;concurrent&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-11 grvsc-tJmpaV-11\">class</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-9 grvsc-tJmpaV-9\">HelloAsync</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">  </span><span class=\"grvsc-t564vY-10 grvsc-tJmpaV-10\">include</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-9 grvsc-tJmpaV-9\">Concurrent</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">::</span><span class=\"grvsc-t564vY-8 grvsc-tJmpaV-8\">Async</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">  </span><span class=\"grvsc-t564vY-11 grvsc-tJmpaV-11\">def</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-10 grvsc-tJmpaV-10\">hello_method</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">    </span><span class=\"grvsc-t564vY-10 grvsc-tJmpaV-10\">sleep</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">(</span><span class=\"grvsc-t564vY-4 grvsc-tJmpaV-4\">3</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">    </span><span class=\"grvsc-t564vY-10 grvsc-tJmpaV-10\">puts</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-7 grvsc-tJmpaV-7\">&quot;Hello! My object id is &#39;</span><span class=\"grvsc-t564vY-4 grvsc-tJmpaV-4\">#{</span><span class=\"grvsc-t564vY-7 grvsc-tJmpaV-7\">object_id</span><span class=\"grvsc-t564vY-4 grvsc-tJmpaV-4\">}</span><span class=\"grvsc-t564vY-7 grvsc-tJmpaV-7\">&#39; &quot;</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> \\</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">         </span><span class=\"grvsc-t564vY-7 grvsc-tJmpaV-7\">&quot;and I&#39;m running in thread &quot;</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> \\</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">         </span><span class=\"grvsc-t564vY-7 grvsc-tJmpaV-7\">&quot;&#39;</span><span class=\"grvsc-t564vY-4 grvsc-tJmpaV-4\">#{</span><span class=\"grvsc-t564vY-9 grvsc-tJmpaV-9\">Thread</span><span class=\"grvsc-t564vY-7 grvsc-tJmpaV-7\">.current.object_id</span><span class=\"grvsc-t564vY-4 grvsc-tJmpaV-4\">}</span><span class=\"grvsc-t564vY-7 grvsc-tJmpaV-7\">&#39;.&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">  </span><span class=\"grvsc-t564vY-11 grvsc-tJmpaV-11\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-11 grvsc-tJmpaV-11\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">hello_instance </span><span class=\"grvsc-t564vY-6 grvsc-tJmpaV-6\">=</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-9 grvsc-tJmpaV-9\">HelloAsync</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">.</span><span class=\"grvsc-t564vY-10 grvsc-tJmpaV-10\">new</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-10 grvsc-tJmpaV-10\">print</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-7 grvsc-tJmpaV-7\">&#39;&gt; &#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-11 grvsc-tJmpaV-11\">while</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> (input </span><span class=\"grvsc-t564vY-6 grvsc-tJmpaV-6\">=</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-10 grvsc-tJmpaV-10\">gets</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">  </span><span class=\"grvsc-t564vY-11 grvsc-tJmpaV-11\">case</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> input</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">  </span><span class=\"grvsc-t564vY-11 grvsc-tJmpaV-11\">when</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-8 grvsc-tJmpaV-8\">/^</span><span class=\"grvsc-t564vY-5 grvsc-tJmpaV-5\">[qQxX]</span><span class=\"grvsc-t564vY-8 grvsc-tJmpaV-8\">/</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">    </span><span class=\"grvsc-t564vY-10 grvsc-tJmpaV-10\">puts</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-7 grvsc-tJmpaV-7\">&#39;Quitting...&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">    </span><span class=\"grvsc-t564vY-10 grvsc-tJmpaV-10\">exit</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">(</span><span class=\"grvsc-t564vY-4 grvsc-tJmpaV-4\">0</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">  </span><span class=\"grvsc-t564vY-11 grvsc-tJmpaV-11\">when</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-8 grvsc-tJmpaV-8\">/^l(ist)?/</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">    </span><span class=\"grvsc-t564vY-10 grvsc-tJmpaV-10\">puts</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-7 grvsc-tJmpaV-7\">&quot;Currently have </span><span class=\"grvsc-t564vY-4 grvsc-tJmpaV-4\">#{</span><span class=\"grvsc-t564vY-9 grvsc-tJmpaV-9\">Thread</span><span class=\"grvsc-t564vY-7 grvsc-tJmpaV-7\">.list.count</span><span class=\"grvsc-t564vY-4 grvsc-tJmpaV-4\">}</span><span class=\"grvsc-t564vY-7 grvsc-tJmpaV-7\"> threads.&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">  </span><span class=\"grvsc-t564vY-11 grvsc-tJmpaV-11\">when</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-8 grvsc-tJmpaV-8\">/^async/</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">    hello_instance.async.hello_method</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">  </span><span class=\"grvsc-t564vY-11 grvsc-tJmpaV-11\">when</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-8 grvsc-tJmpaV-8\">/^await/</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">    hello_instance.await.hello_method</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">  </span><span class=\"grvsc-t564vY-11 grvsc-tJmpaV-11\">when</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-8 grvsc-tJmpaV-8\">/^new-async/</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">    </span><span class=\"grvsc-t564vY-9 grvsc-tJmpaV-9\">HelloAsync</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">.</span><span class=\"grvsc-t564vY-10 grvsc-tJmpaV-10\">new</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">.async.hello_method</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">  </span><span class=\"grvsc-t564vY-11 grvsc-tJmpaV-11\">when</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-8 grvsc-tJmpaV-8\">/^new-await/</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">    </span><span class=\"grvsc-t564vY-9 grvsc-tJmpaV-9\">HelloAsync</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">.</span><span class=\"grvsc-t564vY-10 grvsc-tJmpaV-10\">new</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">.await.hello_method</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">  </span><span class=\"grvsc-t564vY-11 grvsc-tJmpaV-11\">else</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-10 grvsc-tJmpaV-10\">puts</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-7 grvsc-tJmpaV-7\">&quot;Received unknown input: </span><span class=\"grvsc-t564vY-4 grvsc-tJmpaV-4\">#{</span><span class=\"grvsc-t564vY-7 grvsc-tJmpaV-7\">input</span><span class=\"grvsc-t564vY-4 grvsc-tJmpaV-4\">}</span><span class=\"grvsc-t564vY-7 grvsc-tJmpaV-7\">&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">  </span><span class=\"grvsc-t564vY-11 grvsc-tJmpaV-11\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">  </span><span class=\"grvsc-t564vY-10 grvsc-tJmpaV-10\">print</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-7 grvsc-tJmpaV-7\">&#39;&gt; &#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-11 grvsc-tJmpaV-11\">end</span></span></span></code></pre>\n<p>If you are interested in trying this out for yourself, it's also available <a href=\"https://github.com/tmr08c/trying-concurrent-ruby/blob/master/01-hello-async.rb\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">on GitHub</a>.</p>\n<h2 id=\"baseline\" style=\"position:relative;\"><a href=\"#baseline\" aria-label=\"baseline permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Baseline</h2>\n<p>When starting the REPL and printing out the thread count I see the following:</p>\n<pre class=\"grvsc-container tomorrow grvsc-ps-tJmpaV\" data-language=\"markup\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">&gt; list</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Currently have 2 threads.</span></span></code></pre>\n<p>I didn't <em>expect</em> two threads, but maybe Ruby leverages threads more than I thought. Let's compare this with an <code>irb</code> session:</p>\n<pre class=\"grvsc-container tomorrow grvsc-ps-tJmpaV\" data-language=\"ruby\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">irb</span><span class=\"grvsc-t564vY-6 grvsc-tJmpaV-6\">&gt;</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-9 grvsc-tJmpaV-9\">Thread</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">.list</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">=&gt; [</span><span class=\"grvsc-t564vY-3 grvsc-tJmpaV-3\">#&lt;Thread:0x00007fbef585ffa0 run&gt;]</span></span></span></code></pre>\n<p>Hmm, okay, it looks like we only have one thread. In the <code>irb</code> session I used <code>Thread.list</code> and dropped the <code>count</code>. I am going to temporarily drop the <code>count</code> in my script as well.</p>\n<pre class=\"grvsc-container tomorrow grvsc-ps-tJmpaV\" data-language=\"markup\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">&gt; list</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Currently have [</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  #&lt;Thread:0x00007fdacc064010 run&gt;,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  #&lt;Thread:0x00007fdacc100438@.../concurrent-ruby/concurrent/atomic/ruby_thread_local_var.rb:38 sleep_forever&gt;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">] threads.</span></span></code></pre>\n<p>So we have the same \"run\" thread, but we also have a thread that looks like it's related to the <code>concurrent-ruby</code> gem.</p>\n<h3 id=\"concurrent-ruby-initialize-thread\" style=\"position:relative;\"><a href=\"#concurrent-ruby-initialize-thread\" aria-label=\"concurrent ruby initialize thread permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>concurrent-ruby Initialize Thread</h3>\n<p>This other thread is created during the <code>require</code> process of the\n<code>concurrent-ruby</code> gem (it looks like there is\n<a href=\"https://github.com/ruby-concurrency/concurrent-ruby/issues/868\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">discussion</a> of\nwhether that is the right time to do this) as a part managing\n<a href=\"https://ruby-concurrency.github.io/concurrent-ruby/1.1.5/Concurrent/ThreadLocalVar.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><code>ThreadLocalVar</code></a>s.\nThis means that the additional thread is created <em>prior</em> to creating a new\ninstance of our <code>HelloAsync</code> class - it's created as soon as we <code>require 'concurrent'</code>.</p>\n<p>We can reproduce this in <code>irb</code> as well:</p>\n<pre class=\"grvsc-container tomorrow grvsc-ps-tJmpaV\" data-language=\"ruby\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">irb</span><span class=\"grvsc-t564vY-6 grvsc-tJmpaV-6\">&gt;</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-9 grvsc-tJmpaV-9\">Thread</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">.list</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">=&gt; [</span><span class=\"grvsc-t564vY-3 grvsc-tJmpaV-3\">#&lt;Thread:0x00007f912a85ffa8 run&gt;]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">irb</span><span class=\"grvsc-t564vY-6 grvsc-tJmpaV-6\">&gt;</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-10 grvsc-tJmpaV-10\">require</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-7 grvsc-tJmpaV-7\">&#39;concurrent&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">=&gt; </span><span class=\"grvsc-t564vY-4 grvsc-tJmpaV-4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">irb</span><span class=\"grvsc-t564vY-6 grvsc-tJmpaV-6\">&gt;</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-9 grvsc-tJmpaV-9\">Thread</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">.list</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">=&gt; [</span><span class=\"grvsc-t564vY-3 grvsc-tJmpaV-3\">#&lt;Thread:0x00007f912a85ffa8 run&gt;,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">    </span><span class=\"grvsc-t564vY-3 grvsc-tJmpaV-3\">#&lt;Thread:0x00007f91299453b0@.../concurrent-ruby/concurrent/atomic/ruby_thread_local_var.rb:38 sleep_forever&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">]</span></span></span></code></pre>\n<p>The implementation tracks and manages <code>ThreadLocalVar</code>s in a <a href=\"https://github.com/ruby-concurrency/concurrent-ruby/blob/082c05f136309fd7be56e7c1b07a4edcb93968f4/lib/concurrent-ruby/concurrent/atomic/ruby_thread_local_var.rb#L38-L39\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">long-running thread</a>. We haven't yet begun digging into the <a href=\"https://github.com/ruby-concurrency/concurrent-ruby#thread-safe-value-objects-structures-and-collections\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">thread-safe objects the library provides</a> yet, so we shouldn't need to worry too much about this additional thread.</p>\n<p>The important things to note are:</p>\n<ol>\n<li>The baselines thread count is two.</li>\n<li>The baseline does <strong>not</strong> include any threads created by the <code>HelloAsync</code> class.</li>\n</ol>\n<h3 id=\"multiple-rubies-support\" style=\"position:relative;\"><a href=\"#multiple-rubies-support\" aria-label=\"multiple rubies support permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Multiple Rubies Support</h3>\n<p>You may note that the file referenced in the thread is <code>ruby_thread_local_var.rb</code> and not just <code>thread_local_var.rb</code>. <code>ThreadLocalVar</code> has <a href=\"https://github.com/ruby-concurrency/concurrent-ruby/blob/082c05f136309fd7be56e7c1b07a4edcb93968f4/lib/concurrent-ruby/concurrent/atomic/thread_local_var.rb#L60-L65\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">implementations for Ruby and JRuby</a>. Since I am using MRI, I am seeing <code>RubyThreadLocalVar</code> and not <code>JavaThreadLocalVar</code>.</p>\n<p>I mention this because there may be other instances where I reference the gem's MRI implementation, but you may see something different.</p>\n<h2 id=\"our-first-or-third-thread\" style=\"position:relative;\"><a href=\"#our-first-or-third-thread\" aria-label=\"our first or third thread permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Our first (or third) thread</h2>\n<p>In our <a href=\"/2020/05/concurrent-ruby-hello-async/\">previous post</a> we learned that the <code>await</code> method would create a new thread, run the method in the new thread, and return to the main thread; blocking our main thread the whole time. Does the thread stick around when it is done running the method?</p>\n<pre class=\"grvsc-container tomorrow grvsc-ps-tJmpaV\" data-language=\"markup\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">&gt; await</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Hello! My object id is &#39;70161458709520&#39; \\</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">and I&#39;m running in thread &#39;70161462091140&#39;.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&gt; list</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Currently have 3 threads.</span></span></code></pre>\n<p>It seems it does.</p>\n<p>Does this mean that every time we use one of our proxy methods we are going to have extraneous threads that stick around?</p>\n<pre class=\"grvsc-container tomorrow grvsc-ps-tJmpaV\" data-language=\"markup\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">&gt; await</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Hello! My object id is &#39;70161458709520&#39; \\</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">and I&#39;m running in thread &#39;70161462091140&#39;.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&gt; list</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Currently have 3 threads.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&gt; await</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Hello! My object id is &#39;70161458709520&#39; \\</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">and I&#39;m running in thread &#39;70161462091140&#39;.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&gt; list</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Currently have 3 threads.</span></span></code></pre>\n<p>When running the <code>await</code> command multiple times, we are seeing the same object and thread IDs. The object ID makes sense since in our <a href=\"#command-options\">REPL</a> we had the <code>await</code> command use the same object. However, the same thread ID wasn't something we intentionally set up.</p>\n<p>This means we are <strong>reusing our thread</strong>. Rather than having threads created and left around, the library is reusing them for subsequent calls. This is great, as it helps save on the cost of starting up and maintaining a new thread.</p>\n<h2 id=\"fancy-another\" style=\"position:relative;\"><a href=\"#fancy-another\" aria-label=\"fancy another permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Fancy another</h2>\n<p>So far, we've learned that <code>concurrent-ruby</code> will reuse our thread when calling <code>await</code> on the same instance of a class. What happens if we instantiate a new instance of our <code>HelloAsync</code> class? This is where the <a href=\"#command-options\"><code>new-await</code> command</a> in our REPL comes into play.</p>\n<pre class=\"grvsc-container tomorrow grvsc-ps-tJmpaV\" data-language=\"markup\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">&gt; await</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Hello! My object id is &#39;70161458709520&#39; \\</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">and I&#39;m running in thread &#39;70161462091140&#39;.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&gt; list</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Currently have 3 threads.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&gt; new-await</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Hello! My object id is &#39;70161462088680&#39; \\</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">and I&#39;m running in thread &#39;70161462091140&#39;.</span></span></code></pre>\n<p>On closer inspection, we <em>are</em> seeing a new object ID, but the same thread ID:</p>\n<pre class=\"grvsc-container grvsc-has-line-highlighting tomorrow grvsc-ps-tJmpaV\" data-language=\"\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line grvsc-line-diff grvsc-line-diff-del\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-diff-del\" aria-hidden=\"true\" data-content=\"-\"></span><span class=\"grvsc-source\">Hello! My object id is &#39;70161458709520&#39; \\</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\">and I&#39;m running in thread &#39;70161462091140&#39;.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line grvsc-line-diff grvsc-line-diff-add\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-diff-add\" aria-hidden=\"true\" data-content=\"+\"></span><span class=\"grvsc-source\">Hello! My object id is &#39;70161462088680&#39; \\</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\">and I&#39;m running in thread &#39;70161462091140&#39;.</span></span></code></pre>\n<p>This indicates that <code>concurrent-ruby</code> will reuse threads, even across new instances of our <code>Async</code>-inheriting classes.</p>\n<h2 id=\"what-are-you-awaiting-for\" style=\"position:relative;\"><a href=\"#what-are-you-awaiting-for\" aria-label=\"what are you awaiting for permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>What are you (a)waiting for</h2>\n<p>At this point, all of our tests have only used the <code>await</code> proxy method. Since this method will block our main thread until it's complete, we aren't sending multiple requests to multiple objects at a time. This does seem like it would make it easier to reuse the same thread. Do we see the same behavior with <code>async</code>?</p>\n<p>Let's start with our <code>async</code> action. This will run the <code>hello_method</code> method through the <code>async</code> proxy on our existing instance of <code>HelloAsync</code>.</p>\n<pre class=\"grvsc-container tomorrow grvsc-ps-tJmpaV\" data-language=\"markup\" data-index=\"13\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">&gt; async</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Hello! My object id is &#39;70161458709520&#39; \\</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">and I&#39;m running in thread &#39;70161462091140&#39;.</span></span></code></pre>\n<p>Since we are using our existing instance, it makes sense to see our same object ID. After what we've learned so far about thread reuse, it's not a complete surprise to see the same thread ID again either (despite a different proxy method being used).</p>\n<p>As we mentioned above, since <code>async</code> doesn't block our main thread, we can call it multiple times. If we can get multiple calls to <code>async</code> queued up, should things be running concurrently through multiple threads?</p>\n<pre class=\"grvsc-container tomorrow grvsc-ps-tJmpaV\" data-language=\"markup\" data-index=\"14\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">&gt; async</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&gt; list</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Currently have 3 threads.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&gt; async</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&gt; list</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Currently have 3 threads.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&gt; async</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Hello! My object id is &#39;70161458709520&#39; \\</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">and I&#39;m running in thread &#39;70161462091140&#39;.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&gt; list</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Currently have 3 threads.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&gt; async</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&gt; list</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Currently have 3 threads.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Hello! My object id is &#39;70161458709520&#39; \\</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">and I&#39;m running in thread &#39;70161462091140&#39;.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&gt; list</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Currently have 3 threads.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Hello! My object id is &#39;70161458709520&#39; \\</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">and I&#39;m running in thread &#39;70161462091140&#39;.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&gt; list</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Currently have 3 threads.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Hello! My object id is &#39;70161458709520&#39; \\</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">and I&#39;m running in thread &#39;70161462091140&#39;.</span></span></code></pre>\n<p>Above, we have multiple calls to <code>async</code> and <code>list</code>. The goal was to see if calling <code>async</code> multiple times before the method is completed (and we see our print statement) could increase our thread count. We seem to still be using our same object ID and thread ID, and never go above three threads. What's the deal? How are we going to do things concurrently if we don't spawn more threads?</p>\n<h3 id=\"actors-and-mailboxes\" style=\"position:relative;\"><a href=\"#actors-and-mailboxes\" aria-label=\"actors and mailboxes permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Actors and Mailboxes</h3>\n<p>Because the <code>Async</code> module is modeling itself off of <a href=\"https://erlang.org/doc/man/gen_server.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><code>gen_server</code></a>, it uses the <a href=\"https://en.wikipedia.org/wiki/Actor_model#Message-passing_semantics\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">message-passing semantics</a> of the Actor model.</p>\n<p><a href=\"https://stackoverflow.com/a/10816216/2475008\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">This StackOverflow answer</a> from erlang co-creator Robert Virding explains what that means:</p>\n<blockquote>\n<p>All messages are placed in a process' message queue and processes handle their message one-by-one. If a message arrives while a process is busy then it is placed in the message queue.</p>\n</blockquote>\n<p>Staying true to their inspiration, <code>concurrent-ruby</code> follows a similar idea of queuing up the method calls an object receives. The object will then process (i.e., run) the methods one at a time. <a href=\"https://github.com/ruby-concurrency/concurrent-ruby/blob/082c05f136309fd7be56e7c1b07a4edcb93968f4/lib/concurrent-ruby/concurrent/async.rb#L323-L334\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Here</a> is the relevant code in the gem:</p>\n<pre class=\"grvsc-container tomorrow grvsc-ps-tJmpaV\" data-language=\"ruby\" data-index=\"15\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-3 grvsc-tJmpaV-3\"># This is in the `AsyncDelegator`</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-3 grvsc-tJmpaV-3\"># class defined within the `Async` module</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-11 grvsc-tJmpaV-11\">def</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-10 grvsc-tJmpaV-10\">method_missing</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">(</span><span class=\"grvsc-t564vY-4 grvsc-tJmpaV-4\">method</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">, </span><span class=\"grvsc-t564vY-11 grvsc-tJmpaV-11\">*</span><span class=\"grvsc-t564vY-4 grvsc-tJmpaV-4\">args</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">, </span><span class=\"grvsc-t564vY-11 grvsc-tJmpaV-11\">&amp;</span><span class=\"grvsc-t564vY-4 grvsc-tJmpaV-4\">block</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">  </span><span class=\"grvsc-t564vY-11 grvsc-tJmpaV-11\">super</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-11 grvsc-tJmpaV-11\">unless</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-8 grvsc-tJmpaV-8\">@delegate</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">.respond_to?(method)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">  </span><span class=\"grvsc-t564vY-9 grvsc-tJmpaV-9\">Async</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">::validate_argc(</span><span class=\"grvsc-t564vY-8 grvsc-tJmpaV-8\">@delegate</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">, method, </span><span class=\"grvsc-t564vY-6 grvsc-tJmpaV-6\">*</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">args)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">  ivar </span><span class=\"grvsc-t564vY-6 grvsc-tJmpaV-6\">=</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-9 grvsc-tJmpaV-9\">Concurrent</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">::</span><span class=\"grvsc-t564vY-9 grvsc-tJmpaV-9\">IVar</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">.</span><span class=\"grvsc-t564vY-10 grvsc-tJmpaV-10\">new</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">  synchronize </span><span class=\"grvsc-t564vY-11 grvsc-tJmpaV-11\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">    </span><span class=\"grvsc-t564vY-8 grvsc-tJmpaV-8\">@queue</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">.push [ivar, method, args, block]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">    </span><span class=\"grvsc-t564vY-8 grvsc-tJmpaV-8\">@executor</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">.post { perform } </span><span class=\"grvsc-t564vY-11 grvsc-tJmpaV-11\">if</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-8 grvsc-tJmpaV-8\">@queue</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">.length </span><span class=\"grvsc-t564vY-6 grvsc-tJmpaV-6\">==</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-4 grvsc-tJmpaV-4\">1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">  </span><span class=\"grvsc-t564vY-11 grvsc-tJmpaV-11\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">  ivar</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-11 grvsc-tJmpaV-11\">end</span></span></span></code></pre>\n<p>Let's try to break this down. Before we get into this <code>method_missing</code> we have to learn a little bit more about the <code>Async</code> module.</p>\n<p>The <code>Async</code> module defines <code>await</code> and <code>async</code> methods. Here is the <code>async</code> method:</p>\n<pre class=\"grvsc-container tomorrow grvsc-ps-tJmpaV\" data-language=\"ruby\" data-index=\"16\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-11 grvsc-tJmpaV-11\">def</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-10 grvsc-tJmpaV-10\">async</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">  </span><span class=\"grvsc-t564vY-8 grvsc-tJmpaV-8\">@__async_delegator__</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-11 grvsc-tJmpaV-11\">end</span></span></span></code></pre>\n<p>This returns an instance variable, <code>@__async_delegator__</code> which is created as a part of the initialization process. The <code>AsyncDelegator</code> is initialized by passing in <code>self</code>. <code>self</code> is the instance of the object that is <em>calling</em> the proxy method. In our case it is <code>hello_instance</code>, our <code>HelloAsync</code> object.</p>\n<pre class=\"grvsc-container grvsc-has-line-highlighting tomorrow grvsc-ps-tJmpaV\" data-language=\"ruby\" data-index=\"17\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-11 grvsc-tJmpaV-11\">def</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-10 grvsc-tJmpaV-10\">init_synchronization</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">  </span><span class=\"grvsc-t564vY-11 grvsc-tJmpaV-11\">return</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-8 grvsc-tJmpaV-8\">self</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-11 grvsc-tJmpaV-11\">if</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-11 grvsc-tJmpaV-11\">defined?</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">(</span><span class=\"grvsc-t564vY-8 grvsc-tJmpaV-8\">@__async_initialized__</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">) </span><span class=\"grvsc-t564vY-6 grvsc-tJmpaV-6\">&amp;&amp;</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-8 grvsc-tJmpaV-8\">@__async_initialized__</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">  </span><span class=\"grvsc-t564vY-8 grvsc-tJmpaV-8\">@__async_initialized__</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-6 grvsc-tJmpaV-6\">=</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-4 grvsc-tJmpaV-4\">true</span></span></span>\n<span class=\"grvsc-line grvsc-line-highlighted\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">  </span><span class=\"grvsc-t564vY-8 grvsc-tJmpaV-8\">@__async_delegator__</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-6 grvsc-tJmpaV-6\">=</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-9 grvsc-tJmpaV-9\">AsyncDelegator</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">.</span><span class=\"grvsc-t564vY-10 grvsc-tJmpaV-10\">new</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">(</span><span class=\"grvsc-t564vY-8 grvsc-tJmpaV-8\">self</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">  </span><span class=\"grvsc-t564vY-8 grvsc-tJmpaV-8\">@__await_delegator__</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-6 grvsc-tJmpaV-6\">=</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-9 grvsc-tJmpaV-9\">AwaitDelegator</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">.</span><span class=\"grvsc-t564vY-10 grvsc-tJmpaV-10\">new</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">(</span><span class=\"grvsc-t564vY-8 grvsc-tJmpaV-8\">@__async_delegator__</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">  </span><span class=\"grvsc-t564vY-8 grvsc-tJmpaV-8\">self</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-11 grvsc-tJmpaV-11\">end</span></span></span></code></pre>\n<p>The <code>AsyncDelegator</code> class is defined within the <code>Async</code> module. This <code>AsyncDelegator</code> class includes the <code>method_missing</code> method we saw above.</p>\n<p>Here's a reminder of what is happening when we type <code>async</code> into our REPL:</p>\n<pre class=\"grvsc-container tomorrow grvsc-ps-tJmpaV\" data-language=\"ruby\" data-index=\"18\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">hello_instance </span><span class=\"grvsc-t564vY-6 grvsc-tJmpaV-6\">=</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-9 grvsc-tJmpaV-9\">HelloAsync</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">.</span><span class=\"grvsc-t564vY-10 grvsc-tJmpaV-10\">new</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-3 grvsc-tJmpaV-3\"># ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-11 grvsc-tJmpaV-11\">when</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-8 grvsc-tJmpaV-8\">/^async/</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-11 grvsc-tJmpaV-11\">then</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> hello_instance.async.hello_method</span></span></span></code></pre>\n<p>We call <code>async</code> on <code>hello_instance</code>. We now know this is giving us an <code>AsyncDelegator</code> that has a reference to our <code>hello_instance</code> object. We then call the method <code>hello_method</code>. However, we aren't calling it on <code>hello_instance</code> (our instance of the <code>HelloAsync</code> class) but instead on our instance of <code>AsyncDelegator</code> (<code>@__async_delegator__</code>). While we haven't looked at the <a href=\"https://github.com/ruby-concurrency/concurrent-ruby/blob/082c05f136309fd7be56e7c1b07a4edcb93968f4/lib/concurrent-ruby/concurrent/async.rb#L301-L364\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">whole <code>AsyncDelegator</code> class</a>, you can probably trust me that it doesn't define a <code>hello_method</code> method.</p>\n<p><em>This</em> is where the <code>method_missing</code> from above comes into play. If you are unfamiliar with <a href=\"https://apidock.com/ruby/BasicObject/method_missing\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><code>method_missing</code></a>, it is invoked when a method is called on an object and that object doesn't have a definition for that method. It is a powerful tool for metaprogramming and is enabling our <code>AsyncDelegator</code> to accept method calls without having to explicitly define them.</p>\n<pre class=\"grvsc-container tomorrow grvsc-ps-tJmpaV\" data-language=\"ruby\" data-index=\"19\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-11 grvsc-tJmpaV-11\">def</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-10 grvsc-tJmpaV-10\">method_missing</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">(</span><span class=\"grvsc-t564vY-4 grvsc-tJmpaV-4\">method</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">, </span><span class=\"grvsc-t564vY-11 grvsc-tJmpaV-11\">*</span><span class=\"grvsc-t564vY-4 grvsc-tJmpaV-4\">args</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">, </span><span class=\"grvsc-t564vY-11 grvsc-tJmpaV-11\">&amp;</span><span class=\"grvsc-t564vY-4 grvsc-tJmpaV-4\">block</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">)</span></span></span></code></pre>\n<p>When we call <code>hello_instance.async.hello_method</code>, our <code>AsyncDelegator</code> (which doesn't define a <code>hello_method</code> method) will invoke <code>method_missing</code> and pass <code>hello_method</code> as the <code>method</code> argument. It will also pass any other arguments and a block if one is included.</p>\n<p>After invoking <code>method_missing</code>, the library will do some validations. First, it will check if the \"delegate\" object (<code>hello_instance</code> in our case) defines the method we are calling. It will then check if the right number of arguments were passed in.</p>\n<pre class=\"grvsc-container tomorrow grvsc-ps-tJmpaV\" data-language=\"ruby\" data-index=\"20\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-11 grvsc-tJmpaV-11\">super</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-11 grvsc-tJmpaV-11\">unless</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-8 grvsc-tJmpaV-8\">@delegate</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">.respond_to?(method)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-9 grvsc-tJmpaV-9\">Async</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">::validate_argc(</span><span class=\"grvsc-t564vY-8 grvsc-tJmpaV-8\">@delegate</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">, method, </span><span class=\"grvsc-t564vY-6 grvsc-tJmpaV-6\">*</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">args)</span></span></span></code></pre>\n<p>After that, we create our <code>IVar</code>. In our <a href=\"/2020/05/concurrent-ruby-hello-async/\">previous post</a> we took a surface-level look at <code>IVar</code>s and decided to not dig into them yet. We will do the same thing here, but note that the <code>IVar</code> is created, some stuff happens (which we will cover next), and then it is returned. This lines up with what we saw in our initial experimentation - we <a href=\"/2020/05/concurrent-ruby-hello-async/#return-types\">found</a> that when using our proxy methods the return value would be an <code>IVar</code> instead of what the original method was returning.</p>\n<pre class=\"grvsc-container tomorrow grvsc-ps-tJmpaV\" data-language=\"ruby\" data-index=\"21\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">  </span><span class=\"grvsc-t564vY-3 grvsc-tJmpaV-3\"># ...stuff from above</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">  ivar </span><span class=\"grvsc-t564vY-6 grvsc-tJmpaV-6\">=</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-9 grvsc-tJmpaV-9\">Concurrent</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">::</span><span class=\"grvsc-t564vY-9 grvsc-tJmpaV-9\">IVar</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">.</span><span class=\"grvsc-t564vY-10 grvsc-tJmpaV-10\">new</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">  </span><span class=\"grvsc-t564vY-3 grvsc-tJmpaV-3\"># Hiding the good stuff for now</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">  ivar</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-11 grvsc-tJmpaV-11\">end</span></span></span></code></pre>\n<p>Next, comes the main functionality.</p>\n<pre class=\"grvsc-container tomorrow grvsc-ps-tJmpaV\" data-language=\"ruby\" data-index=\"22\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">synchronize </span><span class=\"grvsc-t564vY-11 grvsc-tJmpaV-11\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">  </span><span class=\"grvsc-t564vY-8 grvsc-tJmpaV-8\">@queue</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">.push [ivar, method, args, block]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">  </span><span class=\"grvsc-t564vY-8 grvsc-tJmpaV-8\">@executor</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">.post { perform } </span><span class=\"grvsc-t564vY-11 grvsc-tJmpaV-11\">if</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-8 grvsc-tJmpaV-8\">@queue</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">.length </span><span class=\"grvsc-t564vY-6 grvsc-tJmpaV-6\">==</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-4 grvsc-tJmpaV-4\">1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-11 grvsc-tJmpaV-11\">end</span></span></span></code></pre>\n<p>The implementation of <code>synchronize</code> will vary by which type and version of Ruby you are running, but is a mechanism for working with locks. It will check if the thread has access to the lock before <code>yield</code>ing and running whatever is in the block.</p>\n<p>Once we have synchronized, we add an array of information to <code>@queue</code>.   <code>@queue</code> is an array that is created in our initialization process and is the equivalent of the \"mailbox\" concept from erlang.</p>\n<p>We are adding the <code>ivar</code>, <code>method</code>, and the method's arguments and block to the queue. This is everything that is needed to run our method and put the results in an <code>IVar</code> to be consumed later. We will then <code>post</code> a block to our <code>@executor</code>.</p>\n<p>Finding the <code>@executor</code> is another chain of branching inheritance. For my version of MRI Ruby, I eventually got to <a href=\"https://github.com/ruby-concurrency/concurrent-ruby/blob/082c05f136309fd7be56e7c1b07a4edcb93968f4/lib/concurrent-ruby/concurrent/executor/ruby_executor_service.rb#L17-L25\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><code>RubyExecutorService#post</code></a>. The <code>ExecutorService</code> classes is the abstraction for running your code in new threads. These classes take in the arbitrary code to run and handle interacting with threads.</p>\n<p>Along the chain to the <code>RubyExecutorService</code>, one of the parent classes was <a href=\"https://www.rubydoc.info/gems/concurrent-ruby/Concurrent/CachedThreadPool\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><code>CachedThreadPool</code></a>. <strong>This class is key for many of the observations we have seen so far</strong>. From the docs:</p>\n<blockquote>\n<p>A thread pool that dynamically grows and shrinks to fit the current workload. New threads are created as needed, existing threads are reused, and threads that remain idle for too long are killed and removed from the pool.</p>\n</blockquote>\n<p>While this <code>CachedThreadPool</code> pool explains <em>some</em> of what we've seen, it doesn't fully explain why we aren't seeing the thread pool grow dynamically when we proxy through <code>async</code> multiple times. For that, we will need to look at the <code>perform</code> method in <code>AsyncDelegator</code>. This method is what is passed into our <code>@executor</code> to be run in a separate thread</p>\n<pre class=\"grvsc-container tomorrow grvsc-ps-tJmpaV\" data-language=\"ruby\" data-index=\"23\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-3 grvsc-tJmpaV-3\"># Async::AsyncDelegator</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-11 grvsc-tJmpaV-11\">def</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-10 grvsc-tJmpaV-10\">perform</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">  </span><span class=\"grvsc-t564vY-10 grvsc-tJmpaV-10\">loop</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-11 grvsc-tJmpaV-11\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">    ivar, method, args, block </span><span class=\"grvsc-t564vY-6 grvsc-tJmpaV-6\">=</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> synchronize { </span><span class=\"grvsc-t564vY-8 grvsc-tJmpaV-8\">@queue</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">.first }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">    </span><span class=\"grvsc-t564vY-11 grvsc-tJmpaV-11\">break</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-11 grvsc-tJmpaV-11\">unless</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> ivar </span><span class=\"grvsc-t564vY-3 grvsc-tJmpaV-3\"># queue is empty</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">    </span><span class=\"grvsc-t564vY-11 grvsc-tJmpaV-11\">begin</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">      ivar.set(</span><span class=\"grvsc-t564vY-8 grvsc-tJmpaV-8\">@delegate</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">.send(method, </span><span class=\"grvsc-t564vY-6 grvsc-tJmpaV-6\">*</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">args, </span><span class=\"grvsc-t564vY-6 grvsc-tJmpaV-6\">&amp;</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">block))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">    </span><span class=\"grvsc-t564vY-11 grvsc-tJmpaV-11\">rescue</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> =&gt; error</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">      ivar.</span><span class=\"grvsc-t564vY-10 grvsc-tJmpaV-10\">fail</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">(error)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">    </span><span class=\"grvsc-t564vY-11 grvsc-tJmpaV-11\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">    synchronize </span><span class=\"grvsc-t564vY-11 grvsc-tJmpaV-11\">do</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">      </span><span class=\"grvsc-t564vY-8 grvsc-tJmpaV-8\">@queue</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">.shift</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">      </span><span class=\"grvsc-t564vY-11 grvsc-tJmpaV-11\">return</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-11 grvsc-tJmpaV-11\">if</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-8 grvsc-tJmpaV-8\">@queue</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">.empty?</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">    </span><span class=\"grvsc-t564vY-11 grvsc-tJmpaV-11\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">  </span><span class=\"grvsc-t564vY-11 grvsc-tJmpaV-11\">end</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-11 grvsc-tJmpaV-11\">end</span></span></span></code></pre>\n<p><code>perform</code> is passed into the <code>@executor</code> and, when invoked, will loop until the <code>@queue</code> is empty. Each iteration of the loop will run the method originally called and update the <code>ivar</code>.</p>\n<p>So, why do we need the <code>if</code> on the following line?</p>\n<pre class=\"grvsc-container tomorrow grvsc-ps-tJmpaV\" data-language=\"ruby\" data-index=\"24\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"grvsc-t564vY-8 grvsc-tJmpaV-8\">@executor</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">.post { perform } </span><span class=\"grvsc-t564vY-11 grvsc-tJmpaV-11\">if</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-8 grvsc-tJmpaV-8\">@queue</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\">.length </span><span class=\"grvsc-t564vY-6 grvsc-tJmpaV-6\">==</span><span class=\"grvsc-t564vY-1 grvsc-tJmpaV-1\"> </span><span class=\"grvsc-t564vY-4 grvsc-tJmpaV-4\">1</span></span></span></code></pre>\n<p>If <code>@queue</code> isn't empty, the <code>executor</code> would still be in the <code>loop</code> in <code>perform</code>. When we mutate the <code>@queue</code> by calling the <code>push</code> method it is updated everywhere, so our <code>loop</code> will have access to the new element pushed onto the queue. This explains the need to <code>synchronize</code> - when mutating the state of <code>@queue</code> we need to lock first because we could be updating it in our main thread (when we add to it by calling the method through the proxy) or in our <code>@executor</code> thread (in the <code>perform</code> loop when we <code>shift</code> elements off of the queue).</p>\n<p>This shows how the <code>gen_server</code>-style FIFO message queue is implemented in the <code>Async</code> module.</p>\n<ul>\n<li>An <code>AsyncDelegator</code> instance has an instance variable <code>@queue</code> that is an array and stores everything needed to run the method called.</li>\n<li>This array is passed in to the <code>perform</code> method, through a thread pool, and finally to an executor thread that will eventually run our code.</li>\n<li>In <code>perform</code> the thread will loop, executing the next method in the queue, until there is nothing left in the queue.</li>\n</ul>\n<h2 id=\"i-came-here-to-see-multiple-threads\" style=\"position:relative;\"><a href=\"#i-came-here-to-see-multiple-threads\" aria-label=\"i came here to see multiple threads permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>I came here to see multiple threads</h2>\n<p>So far, we've seen the efficiency of <code>CachedThreadPool</code> and the message queue implementation style of <code>gen_stage</code> and how this has resulted in no additional threads spawned. What does it take to make a new thread?</p>\n<h3 id=\"can-we-spawn-one-now\" style=\"position:relative;\"><a href=\"#can-we-spawn-one-now\" aria-label=\"can we spawn one now permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Can we spawn one, now</h3>\n<p>We've already seen <code>CachedThreadPool</code> pool in action when working with new instances of the <code>HelloAsync</code> class through our <code>new-await</code> command <a href=\"#fancy-another\">above</a>. It may not be surprising to find that <code>new-async</code> (when called when no other commands are running) behaves similarly:</p>\n<pre class=\"grvsc-container tomorrow grvsc-ps-tJmpaV\" data-language=\"markup\" data-index=\"25\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">&gt; new-async</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&gt; list</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Currently have 3 threads.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Hello! My object id is &#39;70161458746800&#39; \\</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">and I&#39;m running in thread &#39;70161462091140&#39;.</span></span></code></pre>\n<h3 id=\"okay-how-about-now\" style=\"position:relative;\"><a href=\"#okay-how-about-now\" aria-label=\"okay how about now permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Okay, how about now</h3>\n<p>So, again, <code>CachedThreadPool</code> can reuse threads across instances of our <code>HelloAsync</code> class. But if we re-read the class's description, we know that threads are created \"as needed.\"</p>\n<blockquote>\n<p>New threads are created as needed, existing threads are reused, (...)</p>\n</blockquote>\n<p>So far, we haven't see the \"as needed\" case. What if we run <em>multiple</em> <code>new-async</code> commands? Since it's <code>async</code> we should be able to request them multiple times view our REPL and since each request goes to a new instance, there is no waiting in the queue.</p>\n<pre class=\"grvsc-container tomorrow grvsc-ps-tJmpaV\" data-language=\"markup\" data-index=\"26\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">&gt; new-async</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&gt; new-async</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&gt; new-async</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&gt; new-async</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&gt; new-async</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&gt; new-async</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&gt; new-async</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&gt; list</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Currently have 9 threads.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Hello! My object id is &#39;70161189799440&#39; \\</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">and I&#39;m running in thread &#39;70161462091140&#39;.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Hello! My object id is &#39;70161189798560&#39; \\</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">and I&#39;m running in thread &#39;70161458745000&#39;.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Hello! My object id is &#39;70161458781960&#39; \\\\</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">and I&#39;m running in thread &#39;70161458781240&#39;.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Hello! My object id is &#39;70161458780740&#39; \\</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">and I&#39;m running in thread &#39;70161458780020&#39;.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Hello! My object id is &#39;70161458779520&#39; \\</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">and I&#39;m running in thread &#39;70161458778800&#39;.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Hello! My object id is &#39;70161458778300&#39; \\</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">and I&#39;m running in thread &#39;70161458777580&#39;.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Hello! My object id is &#39;70161458777080&#39; \\</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">and I&#39;m running in thread &#39;70161458776360&#39;.</span></span></code></pre>\n<p>At last! We've found a way to spawn more threads.</p>\n<h2 id=\"conclusion\" style=\"position:relative;\"><a href=\"#conclusion\" aria-label=\"conclusion permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Conclusion</h2>\n<p>While we haven't <em>used</em> the <code>Async</code> module in any meaningful way yet, these simple thread count checks have begun to lead us through implementation details of the <code>concurrent-ruby</code> gem. Hopefully, this exploration has provided us with a better understanding and appreciation of the gem.</p>\n<p>I initially set out expecting to see a lot of thread creation. Instead, I learned that, thanks to <code>concurrent-ruby</code>, threads can be lazy (in the best way!). While the message processing aspects of <code>gen_stage</code> (and therefore the <code>Async</code> module) played a role in the lack of needing to spawn as many threads, it was the abstractions provided by <code>concurrent-ruby</code> that helped make things seamless. Since I imagine most people reach for a gem like <code>concurrent-ruby</code> for performance reasons, it's great to know that it has your back.</p>\n<p>If you're interested in trying out different ways to create threads with the <code>Async</code> module, the code for the REPL is available <a href=\"https://github.com/tmr08c/trying-concurrent-ruby/blob/master/01-hello-async.rb\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">on\nGitHub</a>.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .tomorrow {\n    background-color: #FFFFFF;\n    color: #4D4D4C;\n  }\n  .tomorrow .grvsc-t564vY-10 { color: #4271AE; }\n  .tomorrow .grvsc-t564vY-1 { color: #4D4D4C; }\n  .tomorrow .grvsc-t564vY-7 { color: #718C00; }\n  .tomorrow .grvsc-t564vY-11 { color: #8959A8; }\n  .tomorrow .grvsc-t564vY-9 { color: #C99E00; }\n  .tomorrow .grvsc-t564vY-8 { color: #C82829; }\n  .tomorrow .grvsc-t564vY-4 { color: #F5871F; }\n  .tomorrow .grvsc-t564vY-6 { color: #3E999F; }\n  .tomorrow .grvsc-t564vY-5 { color: #666969; }\n  .tomorrow .grvsc-t564vY-3 { color: #8E908C; }\n  .tomorrow .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(0, 0, 0, 0.05));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(0, 0, 0, 0.2));\n  }\n  body.dark .grvsc-ps-tJmpaV {\n    background-color: #1D1F21;\n    color: #C5C8C6;\n  }\n  body.dark .grvsc-ps-tJmpaV .grvsc-tJmpaV-10 { color: #81A2BE; }\n  body.dark .grvsc-ps-tJmpaV .grvsc-tJmpaV-1 { color: #C5C8C6; }\n  body.dark .grvsc-ps-tJmpaV .grvsc-tJmpaV-7 { color: #B5BD68; }\n  body.dark .grvsc-ps-tJmpaV .grvsc-tJmpaV-11 { color: #B294BB; }\n  body.dark .grvsc-ps-tJmpaV .grvsc-tJmpaV-9 { color: #F0C674; }\n  body.dark .grvsc-ps-tJmpaV .grvsc-tJmpaV-8 { color: #CC6666; }\n  body.dark .grvsc-ps-tJmpaV .grvsc-tJmpaV-4 { color: #DE935F; }\n  body.dark .grvsc-ps-tJmpaV .grvsc-tJmpaV-6 { color: #8ABEB7; }\n  body.dark .grvsc-ps-tJmpaV .grvsc-tJmpaV-5 { color: #CED1CF; }\n  body.dark .grvsc-ps-tJmpaV .grvsc-tJmpaV-3 { color: #969896; }\n  body.dark .grvsc-ps-tJmpaV .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","frontmatter":{"title":"Concurrent Ruby - Lazy Threads","date":"September 10, 2020"}}},"pageContext":{"slug":"/2020/09/concurrent-ruby-lazy-threads/","previous":{"fields":{"slug":"/2020/08/initialize-hash-value-in-ruby/"},"frontmatter":{"title":"Initial Hash Value in Ruby"}},"next":{"fields":{"slug":"/2020/10/contributing-github-actions/"},"frontmatter":{"title":"Contributing GitHub Actions"}}}},"staticQueryHashes":["3128451518","3649515864"]}